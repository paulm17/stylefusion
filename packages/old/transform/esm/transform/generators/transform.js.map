{"version":3,"file":"transform.js","names":["buildOptions","getTransformMetadata","getPluginKey","EMPTY_FILE","hasKeyInList","plugin","list","pluginKey","some","i","includes","runPreevalStage","babel","evalConfig","pluginOptions","code","originalAst","eventEmitter","preShakePlugins","plugins","filter","highPriorityPlugins","require","resolve","transformConfig","envName","result","transformFromAstSync","ast","program","Error","prepareCode","services","item","log","only","loadedAndParsed","evaluator","options","preevalStageResult","perf","transformMetadata","metadata","length","name","extend","evaluatorConfig","onlyExports","features","transformedCode","imports","internalTransform","prepareFn","entrypoint","preparedCode","size","resolvedImports","getNext","resolved","transform","call"],"sources":["../../../src/transform/generators/transform.ts"],"sourcesContent":["import type {\n  BabelFileResult,\n  PluginItem,\n  TransformOptions,\n} from '@babel/core';\nimport type { File } from '@babel/types';\n\nimport type { EvaluatorConfig, StrictOptions } from '@wyw-in-js/shared';\n\nimport type { Core } from '../../babel';\nimport { buildOptions } from '../../options/buildOptions';\nimport type { EventEmitter } from '../../utils/EventEmitter';\nimport type { WYWTransformMetadata } from '../../utils/TransformMetadata';\nimport { getTransformMetadata } from '../../utils/TransformMetadata';\nimport { getPluginKey } from '../../utils/getPluginKey';\nimport type { Entrypoint } from '../Entrypoint';\nimport type {\n  ITransformAction,\n  Services,\n  SyncScenarioForAction,\n} from '../types';\n\nconst EMPTY_FILE = '=== empty file ===';\n\nconst hasKeyInList = (plugin: PluginItem, list: string[]): boolean => {\n  const pluginKey = getPluginKey(plugin);\n  return pluginKey ? list.some((i) => pluginKey.includes(i)) : false;\n};\n\nfunction runPreevalStage(\n  babel: Core,\n  evalConfig: TransformOptions,\n  pluginOptions: StrictOptions,\n  code: string,\n  originalAst: File,\n  eventEmitter: EventEmitter\n): BabelFileResult {\n  const preShakePlugins =\n    evalConfig.plugins?.filter((i) =>\n      hasKeyInList(i, pluginOptions.highPriorityPlugins)\n    ) ?? [];\n\n  const plugins = [\n    ...preShakePlugins,\n    [\n      require.resolve('../../plugins/preeval'),\n      { ...pluginOptions, eventEmitter },\n    ],\n    [require.resolve('../../plugins/dynamic-import')],\n    ...(evalConfig.plugins ?? []).filter(\n      (i) => !hasKeyInList(i, pluginOptions.highPriorityPlugins)\n    ),\n  ];\n\n  const transformConfig = buildOptions({\n    ...evalConfig,\n    envName: 'wyw-in-js',\n    plugins,\n  });\n\n  const result = babel.transformFromAstSync(originalAst, code, transformConfig);\n\n  if (!result || !result.ast?.program) {\n    throw new Error('Babel transform failed');\n  }\n\n  return result;\n}\n\ntype PrepareCodeFn = (\n  services: Services,\n  item: Entrypoint,\n  originalAst: File\n) => [\n  code: string,\n  imports: Map<string, string[]> | null,\n  metadata: WYWTransformMetadata | null,\n];\n\nexport const prepareCode = (\n  services: Services,\n  item: Entrypoint,\n  originalAst: File\n): ReturnType<PrepareCodeFn> => {\n  const { log, only, loadedAndParsed } = item;\n  if (loadedAndParsed.evaluator === 'ignored') {\n    log('is ignored');\n    return [loadedAndParsed.code ?? '', null, null];\n  }\n\n  const { code, evalConfig, evaluator } = loadedAndParsed;\n  const { options, babel, eventEmitter } = services;\n  const { pluginOptions } = options;\n\n  const preevalStageResult = eventEmitter.perf('transform:preeval', () =>\n    runPreevalStage(\n      babel,\n      evalConfig,\n      pluginOptions,\n      code,\n      originalAst,\n      eventEmitter\n    )\n  );\n\n  const transformMetadata = getTransformMetadata(preevalStageResult.metadata);\n\n  if (only.length === 1 && only[0] === '__wywPreval' && !transformMetadata) {\n    log('[evaluator:end] no metadata');\n    return [preevalStageResult.code!, null, null];\n  }\n\n  log('[preeval] metadata %O', transformMetadata);\n  log('[evaluator:start] using %s', evaluator.name);\n  log.extend('source')('%s', preevalStageResult.code!);\n\n  const evaluatorConfig: EvaluatorConfig = {\n    onlyExports: only,\n    highPriorityPlugins: pluginOptions.highPriorityPlugins,\n    features: pluginOptions.features,\n  };\n\n  const [, transformedCode, imports] = eventEmitter.perf(\n    'transform:evaluator',\n    () =>\n      evaluator(\n        evalConfig,\n        preevalStageResult.ast!,\n        preevalStageResult.code!,\n        evaluatorConfig,\n        babel\n      )\n  );\n\n  log('[evaluator:end]');\n\n  return [transformedCode, imports, transformMetadata ?? null];\n};\n\nexport function* internalTransform(\n  this: ITransformAction,\n  prepareFn: PrepareCodeFn\n): SyncScenarioForAction<ITransformAction> {\n  const { only, loadedAndParsed, log } = this.entrypoint;\n  if (loadedAndParsed.evaluator === 'ignored') {\n    log('is ignored');\n    return {\n      code: loadedAndParsed.code ?? '',\n      metadata: null,\n    };\n  }\n\n  log('>> (%o)', only);\n\n  const [preparedCode, imports, metadata] = prepareFn(\n    this.services,\n    this.entrypoint,\n    loadedAndParsed.ast\n  );\n\n  if (loadedAndParsed.code === preparedCode) {\n    log('<< (%o)\\n === no changes ===', only);\n  } else {\n    log('<< (%o)', only);\n    log.extend('source')('%s', preparedCode || EMPTY_FILE);\n  }\n\n  if (preparedCode === '') {\n    log('is skipped');\n    return {\n      code: loadedAndParsed.code ?? '',\n      metadata: null,\n    };\n  }\n\n  if (imports !== null && imports.size > 0) {\n    const resolvedImports = yield* this.getNext(\n      'resolveImports',\n      this.entrypoint,\n      {\n        imports,\n      }\n    );\n\n    if (resolvedImports.length !== 0) {\n      yield [\n        'processImports',\n        this.entrypoint,\n        {\n          resolved: resolvedImports,\n        },\n      ];\n    }\n  }\n\n  return {\n    code: preparedCode,\n    metadata,\n  };\n}\n\n/**\n * Prepares the code for evaluation. This includes removing dead and potentially unsafe code.\n * Emits resolveImports and processImports events.\n */\nexport function transform(this: ITransformAction) {\n  return internalTransform.call(this, prepareCode);\n}\n"],"mappings":"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","ignoreList":[]}