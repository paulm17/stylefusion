{"version":3,"file":"getExports.js","names":["collectExportsAndImports","findExportsInImports","entrypoint","imports","results","imp","resolved","Error","source","newEntrypoint","createChild","push","import","getExports","services","cache","loadedAndParsed","ast","undefined","log","name","has","get","withWildcardReexport","result","babel","traverse","Program","path","exports","reexports","Object","keys","forEach","token","e","exported","filter","length","resolvedImports","getNext","Map","map","i","importedEntrypoints","importedEntrypoint","add"],"sources":["../../../src/transform/generators/getExports.ts"],"sourcesContent":["import type { IReexport } from '../../utils/collectExportsAndImports';\nimport { collectExportsAndImports } from '../../utils/collectExportsAndImports';\nimport type { Entrypoint } from '../Entrypoint';\nimport type { IEntrypointDependency } from '../Entrypoint.types';\nimport type { IGetExportsAction, SyncScenarioForAction } from '../types';\n\nexport function findExportsInImports(\n  entrypoint: Entrypoint,\n  imports: IEntrypointDependency[]\n): { entrypoint: Entrypoint; import: string }[] {\n  const results: {\n    entrypoint: Entrypoint;\n    import: string;\n  }[] = [];\n\n  for (const imp of imports) {\n    const { resolved } = imp;\n    if (!resolved) {\n      throw new Error(`Could not resolve import ${imp.source}`);\n    }\n\n    const newEntrypoint = entrypoint.createChild(resolved, []);\n\n    if (newEntrypoint === 'loop') {\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    results.push({\n      entrypoint: newEntrypoint,\n      import: imp.source,\n    });\n  }\n\n  return results;\n}\n\nexport function* getExports(\n  this: IGetExportsAction\n): SyncScenarioForAction<IGetExportsAction> {\n  const {\n    entrypoint,\n    services: { cache },\n  } = this;\n  const { loadedAndParsed } = entrypoint;\n  if (loadedAndParsed.ast === undefined) {\n    return [];\n  }\n\n  entrypoint.log(`get exports from %s`, entrypoint.name);\n\n  if (cache.has('exports', entrypoint.name)) {\n    return cache.get('exports', entrypoint.name)!;\n  }\n\n  let withWildcardReexport: IReexport[] = [];\n  const result: string[] = [];\n\n  this.services.babel.traverse(loadedAndParsed.ast!, {\n    Program(path) {\n      const { exports, reexports } = collectExportsAndImports(path, 'disabled');\n      Object.keys(exports).forEach((token) => {\n        result.push(token);\n      });\n\n      reexports.forEach((e) => {\n        if (e.exported !== '*') {\n          result.push(e.exported);\n        }\n      });\n\n      withWildcardReexport = reexports.filter((e) => e.exported === '*');\n    },\n  });\n\n  if (withWildcardReexport.length) {\n    const resolvedImports = yield* this.getNext('resolveImports', entrypoint, {\n      imports: new Map(withWildcardReexport.map((i) => [i.source, []])),\n    });\n\n    const importedEntrypoints = findExportsInImports(\n      entrypoint,\n      resolvedImports\n    );\n\n    for (const importedEntrypoint of importedEntrypoints) {\n      const exports = yield* this.getNext(\n        'getExports',\n        importedEntrypoint.entrypoint,\n        undefined\n      );\n\n      result.push(...exports);\n    }\n  }\n\n  entrypoint.log(`exports: %o`, result);\n\n  cache.add('exports', entrypoint.name, result);\n\n  return result;\n}\n"],"mappings":"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","ignoreList":[]}