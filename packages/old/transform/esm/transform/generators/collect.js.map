{"version":3,"file":"collect.js","names":["buildOptions","filename","collectorPlugin","getTransformMetadata","collect","console","log","babel","options","services","valueCache","data","entrypoint","loadedAndParsed","name","evaluator","Error","transformPlugins","pluginOptions","values","transformConfig","envName","plugins","sourceMaps","sourceFileName","inputSourceMap","root","ast","babelrc","configFile","sourceType","result","transformFromAstSync","code","cwd","program","transformMetadata","metadata","map"],"sources":["../../../src/transform/generators/collect.ts"],"sourcesContent":["import type { PluginItem } from '@babel/core';\n\nimport { buildOptions } from '../../options/buildOptions';\nimport { filename as collectorPlugin } from '../../plugins/collector';\nimport { getTransformMetadata } from '../../utils/TransformMetadata';\nimport type { ICollectAction, SyncScenarioForAction } from '../types';\n\n/**\n * Parses the specified file, finds tags, applies run-time replacements,\n * removes dead code.\n */\n// eslint-disable-next-line require-yield\nexport function* collect(\n  this: ICollectAction\n): SyncScenarioForAction<ICollectAction> {\n  console.log(\"transform - collect\");\n  const { babel, options } = this.services;\n  const { valueCache } = this.data;\n  const { entrypoint } = this;\n  const { loadedAndParsed, name } = entrypoint;\n\n  if (loadedAndParsed.evaluator === 'ignored') {\n    throw new Error('entrypoint was ignored');\n  }\n\n  const transformPlugins: PluginItem[] = [\n    [\n      collectorPlugin,\n      {\n        ...options.pluginOptions,\n        values: valueCache,\n      },\n    ],\n  ];\n\n  const transformConfig = buildOptions({\n    envName: 'wyw-in-js',\n    plugins: transformPlugins,\n    sourceMaps: true,\n    sourceFileName: name,\n    inputSourceMap: options.inputSourceMap,\n    root: options.root,\n    ast: true,\n    babelrc: false,\n    configFile: false,\n    sourceType: 'unambiguous',\n  });\n\n  const result = babel.transformFromAstSync(\n    loadedAndParsed.ast,\n    loadedAndParsed.code,\n    {\n      ...transformConfig,\n      cwd: options.root,\n      filename: name,\n    }\n  );\n\n  if (!result || !result.ast?.program) {\n    throw new Error('Babel transform failed');\n  }\n\n  const transformMetadata = getTransformMetadata(result.metadata);\n\n  return {\n    ast: result.ast,\n    code: result.code,\n    map: result.map,\n    metadata: transformMetadata ?? null,\n  };\n}\n"],"mappings":"AAEA,SAASA,YAAY,QAAQ,4BAA4B;AACzD,SAASC,QAAQ,IAAIC,eAAe,QAAQ,yBAAyB;AACrE,SAASC,oBAAoB,QAAQ,+BAA+B;AAGpE;AACA;AACA;AACA;AACA;AACA,OAAO,UAAUC,OAAOA,CAAA,EAEiB;EACvCC,OAAO,CAACC,GAAG,CAAC,qBAAqB,CAAC;EAClC,MAAM;IAAEC,KAAK;IAAEC;EAAQ,CAAC,GAAG,IAAI,CAACC,QAAQ;EACxC,MAAM;IAAEC;EAAW,CAAC,GAAG,IAAI,CAACC,IAAI;EAChC,MAAM;IAAEC;EAAW,CAAC,GAAG,IAAI;EAC3B,MAAM;IAAEC,eAAe;IAAEC;EAAK,CAAC,GAAGF,UAAU;EAE5C,IAAIC,eAAe,CAACE,SAAS,KAAK,SAAS,EAAE;IAC3C,MAAM,IAAIC,KAAK,CAAC,wBAAwB,CAAC;EAC3C;EAEA,MAAMC,gBAA8B,GAAG,CACrC,CACEf,eAAe,EACf;IACE,GAAGM,OAAO,CAACU,aAAa;IACxBC,MAAM,EAAET;EACV,CAAC,CACF,CACF;EAED,MAAMU,eAAe,GAAGpB,YAAY,CAAC;IACnCqB,OAAO,EAAE,WAAW;IACpBC,OAAO,EAAEL,gBAAgB;IACzBM,UAAU,EAAE,IAAI;IAChBC,cAAc,EAAEV,IAAI;IACpBW,cAAc,EAAEjB,OAAO,CAACiB,cAAc;IACtCC,IAAI,EAAElB,OAAO,CAACkB,IAAI;IAClBC,GAAG,EAAE,IAAI;IACTC,OAAO,EAAE,KAAK;IACdC,UAAU,EAAE,KAAK;IACjBC,UAAU,EAAE;EACd,CAAC,CAAC;EAEF,MAAMC,MAAM,GAAGxB,KAAK,CAACyB,oBAAoB,CACvCnB,eAAe,CAACc,GAAG,EACnBd,eAAe,CAACoB,IAAI,EACpB;IACE,GAAGb,eAAe;IAClBc,GAAG,EAAE1B,OAAO,CAACkB,IAAI;IACjBzB,QAAQ,EAAEa;EACZ,CACF,CAAC;EAED,IAAI,CAACiB,MAAM,IAAI,CAACA,MAAM,CAACJ,GAAG,EAAEQ,OAAO,EAAE;IACnC,MAAM,IAAInB,KAAK,CAAC,wBAAwB,CAAC;EAC3C;EAEA,MAAMoB,iBAAiB,GAAGjC,oBAAoB,CAAC4B,MAAM,CAACM,QAAQ,CAAC;EAE/D,OAAO;IACLV,GAAG,EAAEI,MAAM,CAACJ,GAAG;IACfM,IAAI,EAAEF,MAAM,CAACE,IAAI;IACjBK,GAAG,EAAEP,MAAM,CAACO,GAAG;IACfD,QAAQ,EAAED,iBAAiB,IAAI;EACjC,CAAC;AACH","ignoreList":[]}