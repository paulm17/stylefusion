{"version":3,"file":"actionRunner.js","names":["Pending","AbortError","getHandler","action","actionHandlers","handler","type","Error","getActionRef","entrypoint","ref","ACTION_ERROR","Symbol","isActionError","e","Array","isArray","asyncActionRunner","stack","result","log","generator","run","actionResult","abortSignal","aborted","throw","next","done","value","data","nextAction","createAction","syncActionRunner"],"sources":["../../../src/transform/actions/actionRunner.ts"],"sourcesContent":["/* eslint-disable no-await-in-loop */\nimport type {\n  ActionQueueItem,\n  Handler,\n  Handlers,\n  TypeOfResult,\n} from '../types';\nimport { Pending } from '../types';\n\nimport { AbortError } from './AbortError';\nimport type { BaseAction } from './BaseAction';\n\nfunction getHandler<\n  TMode extends 'async' | 'sync',\n  TAction extends ActionQueueItem,\n>(\n  action: BaseAction<TAction>,\n  actionHandlers: Handlers<TMode>\n): Handler<TMode, TAction> {\n  const handler = actionHandlers[action.type];\n  if (!handler) {\n    throw new Error(`No handler for action ${action.type}`);\n  }\n\n  // FIXME Handlers<TMode>[TAction['type']] is not assignable to Handler<TMode, TAction>\n  return handler as unknown as Handler<TMode, TAction>;\n}\n\nconst getActionRef = (type: string, entrypoint: { ref: string }) =>\n  `${type}@${entrypoint.ref}`;\n\nconst ACTION_ERROR = Symbol('ACTION_ERROR');\ntype ActionError = [marker: typeof ACTION_ERROR, err: unknown];\nconst isActionError = (e: unknown): e is ActionError =>\n  Array.isArray(e) && e[0] === ACTION_ERROR;\n\nexport async function asyncActionRunner<TAction extends ActionQueueItem>(\n  action: BaseAction<TAction>,\n  actionHandlers: Handlers<'async' | 'sync'>,\n  stack: string[] = [getActionRef(action.type, action.entrypoint)]\n): Promise<TypeOfResult<TAction>> {\n  if (action.result !== Pending) {\n    action.log('result is cached');\n    return action.result as TypeOfResult<TAction>;\n  }\n\n  const handler = getHandler(action, actionHandlers);\n  const generator = action.run<'async' | 'sync'>(handler);\n  let actionResult: TypeOfResult<ActionQueueItem> | ActionError | undefined;\n  // eslint-disable-next-line no-constant-condition\n  while (true) {\n    if (action.abortSignal?.aborted) {\n      action.log('action is aborted');\n      generator.throw(new AbortError(stack[0]));\n    }\n\n    const result = await (isActionError(actionResult)\n      ? generator.throw(actionResult[1])\n      : generator.next(actionResult));\n    if (result.done) {\n      return result.value as TypeOfResult<TAction>;\n    }\n\n    const [type, entrypoint, data, abortSignal] = result.value;\n    const nextAction = entrypoint.createAction(type, data, abortSignal);\n\n    try {\n      actionResult = await asyncActionRunner(nextAction, actionHandlers, [\n        ...stack,\n        getActionRef(type, entrypoint),\n      ]);\n    } catch (e) {\n      nextAction.log('error', e);\n      actionResult = [ACTION_ERROR, e];\n    }\n  }\n}\n\nexport function syncActionRunner<TAction extends ActionQueueItem>(\n  action: BaseAction<TAction>,\n  actionHandlers: Handlers<'sync'>,\n  stack: string[] = [getActionRef(action.type, action.entrypoint)]\n): TypeOfResult<TAction> {\n  if (action.result !== Pending) {\n    action.log('result is cached');\n    return action.result as TypeOfResult<TAction>;\n  }\n\n  const handler = getHandler(action, actionHandlers);\n  const generator = action.run<'sync'>(handler);\n  let actionResult: TypeOfResult<ActionQueueItem> | ActionError | undefined;\n  // eslint-disable-next-line no-constant-condition\n  while (true) {\n    if (action.abortSignal?.aborted) {\n      action.log('action is aborted');\n      generator.throw(new AbortError(stack[0]));\n    }\n\n    const result = isActionError(actionResult)\n      ? generator.throw(actionResult[1])\n      : generator.next(actionResult);\n    if (result.done) {\n      return result.value as TypeOfResult<TAction>;\n    }\n\n    const [type, entrypoint, data, abortSignal] = result.value;\n    const nextAction = entrypoint.createAction(type, data, abortSignal);\n\n    try {\n      actionResult = syncActionRunner(nextAction, actionHandlers, [\n        ...stack,\n        getActionRef(type, entrypoint),\n      ]);\n    } catch (e) {\n      nextAction.log('error', e);\n      actionResult = [ACTION_ERROR, e];\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}