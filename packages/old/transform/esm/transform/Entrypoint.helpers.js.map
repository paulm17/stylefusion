{"version":3,"file":"Entrypoint.helpers.js","names":["readFileSync","dirname","extname","isAbsolute","logger","isFeatureEnabled","buildOptions","loadBabelOptions","getFileIdx","getPluginKey","getMatchedRule","rules","filename","code","console","log","i","length","rule","test","RegExp","action","parseFile","babel","originalCode","parseConfig","extend","parseResult","parseSync","Error","isModuleResolver","plugin","key","includes","moduleResolverWarned","buildConfigs","services","name","pluginOptions","babelOptions","options","commonOptions","ast","inputSourceMap","root","sourceFileName","sourceMaps","rawConfig","useBabelConfigs","features","configFile","babelrc","parseHasModuleResolver","plugins","some","rawHasModuleResolver","warn","filter","evalConfig","loadAndParse","loadedCode","eventEmitter","extension","extensions","evaluator","reason","getOrParse","perf","require","resolve","paths","default","getStack","entrypoint","stack","parents","push","mergeOnly","a","b","result","Set","forEach","item","add","sort","isSuperSet","aSet","every","has"],"sources":["../../src/transform/Entrypoint.helpers.ts"],"sourcesContent":["import { readFileSync } from 'fs';\nimport { dirname, extname, isAbsolute } from 'path';\n\nimport type { TransformOptions, PluginItem } from '@babel/core';\nimport type { File } from '@babel/types';\n\nimport type {\n  Debugger,\n  EvalRule,\n  Evaluator,\n  StrictOptions,\n} from '@wyw-in-js/shared';\nimport { logger, isFeatureEnabled } from '@wyw-in-js/shared';\n\nimport type { Core } from '../babel';\nimport { buildOptions } from '../options/buildOptions';\nimport { loadBabelOptions } from '../options/loadBabelOptions';\nimport type { ParentEntrypoint } from '../types';\nimport { getFileIdx } from '../utils/getFileIdx';\nimport { getPluginKey } from '../utils/getPluginKey';\n\nimport type { IEntrypointCode, IIgnoredEntrypoint } from './Entrypoint.types';\nimport type { Services } from './types';\n\nexport function getMatchedRule(\n  rules: EvalRule[],\n  filename: string,\n  code: string\n): EvalRule {\n  console.log(\"entrypoint.helpers - getMatchedRule\");\n  for (let i = rules.length - 1; i >= 0; i--) {\n    const rule = rules[i];\n    if (!rule.test) {\n      return rule;\n    }\n\n    if (typeof rule.test === 'function' && rule.test(filename, code)) {\n      return rule;\n    }\n\n    if (rule.test instanceof RegExp && rule.test.test(filename)) {\n      return rule;\n    }\n  }\n\n  return { action: 'ignore' };\n}\n\nexport function parseFile(\n  babel: Core,\n  filename: string,\n  originalCode: string,\n  parseConfig: TransformOptions\n): File {\n  console.log(\"entrypoint.helpers - parseFile\");\n  const log = logger.extend('transform:parse').extend(getFileIdx(filename));\n\n  const parseResult = babel.parseSync(originalCode, parseConfig);\n  if (!parseResult) {\n    throw new Error(`Failed to parse ${filename}`);\n  }\n\n  log('stage-1', `${filename} has been parsed`);\n\n  return parseResult;\n}\n\nconst isModuleResolver = (plugin: PluginItem) => {\n  console.log(\"entrypoint.helpers - isModuleResolver\");\n  const key = getPluginKey(plugin);\n  if (!key) return false;\n\n  if (['module-resolver', 'babel-plugin-module-resolver'].includes(key)) {\n    return true;\n  }\n\n  return /([\\\\/])babel-plugin-module-resolver\\1/.test(key);\n};\n\nlet moduleResolverWarned = false;\n\nfunction buildConfigs(\n  services: Services,\n  name: string,\n  pluginOptions: StrictOptions,\n  babelOptions: TransformOptions | undefined\n): {\n  evalConfig: TransformOptions;\n  parseConfig: TransformOptions;\n} {\n  console.log(\"entrypoint.helpers - buildConfigs\");\n  const { babel, options } = services;\n\n  const commonOptions = {\n    ast: true,\n    filename: name,\n    inputSourceMap: options.inputSourceMap,\n    root: options.root,\n    sourceFileName: name,\n    sourceMaps: true,\n  };\n\n  const rawConfig = buildOptions(\n    pluginOptions?.babelOptions,\n    babelOptions,\n    commonOptions\n  );\n\n  const useBabelConfigs = isFeatureEnabled(\n    pluginOptions.features,\n    'useBabelConfigs',\n    name\n  );\n\n  if (!useBabelConfigs) {\n    rawConfig.configFile = false;\n  }\n\n  const parseConfig = loadBabelOptions(babel, name, {\n    babelrc: useBabelConfigs,\n    ...rawConfig,\n  });\n\n  const parseHasModuleResolver = parseConfig.plugins?.some(isModuleResolver);\n  const rawHasModuleResolver = rawConfig.plugins?.some(isModuleResolver);\n\n  if (parseHasModuleResolver && !rawHasModuleResolver) {\n    if (!moduleResolverWarned) {\n      // eslint-disable-next-line no-console\n      console.warn(\n        `[wyw-in-js] ${name} has a module-resolver plugin in its babelrc, but it is not present ` +\n          `in the babelOptions for the wyw-in-js plugin. This works for now but will be an error in the future. ` +\n          `Please add the module-resolver plugin to the babelOptions for the wyw-in-js plugin.`\n      );\n\n      moduleResolverWarned = true;\n    }\n\n    rawConfig.plugins = [\n      ...(parseConfig.plugins?.filter((plugin) => isModuleResolver(plugin)) ??\n        []),\n      ...(rawConfig.plugins ?? []),\n    ];\n  }\n\n  const evalConfig = loadBabelOptions(babel, name, {\n    babelrc: false,\n    ...rawConfig,\n  });\n\n  return {\n    evalConfig,\n    parseConfig,\n  };\n}\n\nexport function loadAndParse(\n  services: Services,\n  name: string,\n  loadedCode: string | undefined,\n  log: Debugger\n): IEntrypointCode | IIgnoredEntrypoint {\n  console.log(\"entrypoint.helpers - loadAndParse\");\n  const {\n    babel,\n    eventEmitter,\n    options: { pluginOptions },\n  } = services;\n\n  const extension = extname(name);\n\n  if (!pluginOptions.extensions.includes(extension)) {\n    log(\n      '[createEntrypoint] %s is ignored. If you want it to be processed, you should add \\'%s\\' to the \"extensions\" option.',\n      name,\n      extension\n    );\n\n    return {\n      get code() {\n        if (isAbsolute(name)) {\n          return loadedCode ?? readFileSync(name, 'utf-8');\n        }\n\n        return ''; // it is a built-in module\n      },\n      evaluator: 'ignored',\n      reason: 'extension',\n    };\n  }\n\n  const code = loadedCode ?? readFileSync(name, 'utf-8');\n\n  const { action, babelOptions } = getMatchedRule(\n    pluginOptions.rules,\n    name,\n    code\n  );\n\n  let ast: File | undefined;\n\n  const { evalConfig, parseConfig } = buildConfigs(\n    services,\n    name,\n    pluginOptions,\n    babelOptions\n  );\n\n  const getOrParse = () => {\n    if (ast) return ast;\n    ast = eventEmitter.perf('parseFile', () =>\n      parseFile(babel, name, code, parseConfig)\n    );\n\n    return ast;\n  };\n\n  if (action === 'ignore') {\n    log('[createEntrypoint] %s is ignored by rule', name);\n    return {\n      get ast() {\n        return getOrParse();\n      },\n      code,\n      evaluator: 'ignored',\n      reason: 'rule',\n    };\n  }\n\n  const evaluator: Evaluator =\n    typeof action === 'function'\n      ? action\n      : require(\n          require.resolve(action, {\n            paths: [dirname(name)],\n          })\n        ).default;\n\n  return {\n    get ast() {\n      return getOrParse();\n    },\n    code,\n    evaluator,\n    evalConfig,\n  };\n}\n\nexport function getStack(entrypoint: ParentEntrypoint) {\n  console.log(\"entrypoint.helpers - getStack\");\n  if (!entrypoint) return [];\n\n  const stack = [entrypoint.name];\n\n  let { parents } = entrypoint;\n  while (parents.length) {\n    stack.push(parents[0].name);\n    parents = parents[0].parents;\n  }\n\n  return stack;\n}\n\nexport function mergeOnly(a: string[], b: string[]) {\n  console.log(\"entrypoint.helpers - mergeOnly\");\n  const result = new Set(a);\n  b.forEach((item) => result.add(item));\n  return [...result].filter((i) => i).sort();\n}\n\nexport const isSuperSet = <T>(a: (T | '*')[], b: (T | '*')[]) => {\n  console.log(\"entrypoint.helpers - isSuperSet\");\n  if (a.includes('*')) return true;\n  if (b.length === 0) return true;\n  const aSet = new Set(a);\n  return b.every((item) => aSet.has(item));\n};\n"],"mappings":"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","ignoreList":[]}