{"version":3,"file":"Entrypoint.js","names":["invariant","BaseEntrypoint","isSuperSet","mergeOnly","EvaluatedEntrypoint","AbortError","BaseAction","UnprocessedEntrypointError","EMPTY_FILE","hasLoop","name","parent","processed","console","log","includes","p","parents","found","Entrypoint","evaluated","onSupersedeHandlers","actionsCache","Map","hasWywMetadata","supersededWith","transformResultCode","constructor","services","initialCode","only","exports","evaluatedOnly","loadedAndParsed","resolveTasks","dependencies","generation","loadAndParseFn","code","undefined","cache","invalidateIfChanged","evaluator","originalCode","extend","ignored","transformedCode","createRoot","loadedCode","created","create","eventEmitter","perf","status","entrypoint","innerCreate","seqId","add","cached","get","changed","mergedOnly","filter","i","isLoop","map","push","supersede","newEntrypoint","addDependency","dependency","delete","source","set","addResolveTask","assertNotSuperseded","assertTransformed","createAction","actionType","data","abortSignal","has","aborted","newAction","entrypointEvent","type","actionIdx","idx","createChild","createEvaluated","exportsProxy","getDependency","getResolveTask","onSupersede","callback","index","indexOf","splice","setTransformResult","res","Boolean","metadata","isNull","newOnlyOrEntrypoint","with","forEach","handler"],"sources":["../../src/transform/Entrypoint.ts"],"sourcesContent":["import { invariant } from 'ts-invariant';\n\nimport type { ParentEntrypoint, ITransformFileResult } from '../types';\n\nimport { BaseEntrypoint } from './BaseEntrypoint';\nimport { isSuperSet, mergeOnly } from './Entrypoint.helpers';\nimport type {\n  IEntrypointCode,\n  IEntrypointDependency,\n  IIgnoredEntrypoint,\n} from './Entrypoint.types';\nimport { EvaluatedEntrypoint } from './EvaluatedEntrypoint';\nimport { AbortError } from './actions/AbortError';\nimport type { ActionByType } from './actions/BaseAction';\nimport { BaseAction } from './actions/BaseAction';\nimport { UnprocessedEntrypointError } from './actions/UnprocessedEntrypointError';\nimport type { Services, ActionTypes, ActionQueueItem } from './types';\n\nconst EMPTY_FILE = '=== empty file ===';\n\nfunction hasLoop(\n  name: string,\n  parent: ParentEntrypoint,\n  processed: string[] = []\n): boolean {\n  console.log(\"Entrypoint - hasLoop\");\n  if (parent.name === name || processed.includes(parent.name)) {\n    return true;\n  }\n\n  for (const p of parent.parents) {\n    const found = hasLoop(name, p, [...processed, parent.name]);\n    if (found) {\n      return found;\n    }\n  }\n\n  return false;\n}\n\nexport class Entrypoint extends BaseEntrypoint {\n  public readonly evaluated = false;\n\n  public readonly loadedAndParsed: IEntrypointCode | IIgnoredEntrypoint;\n\n  protected onSupersedeHandlers: Array<(newEntrypoint: Entrypoint) => void> =\n    [];\n\n  private actionsCache: Map<\n    ActionTypes,\n    Map<unknown, BaseAction<ActionQueueItem>>\n  > = new Map();\n\n  #hasWywMetadata: boolean = false;\n\n  #supersededWith: Entrypoint | null = null;\n\n  #transformResultCode: string | null = null;\n\n  private constructor(\n    services: Services,\n    parents: ParentEntrypoint[],\n    public readonly initialCode: string | undefined,\n    name: string,\n    only: string[],\n    exports: Record<string | symbol, unknown> | undefined,\n    evaluatedOnly: string[],\n    loadedAndParsed?: IEntrypointCode | IIgnoredEntrypoint,\n    protected readonly resolveTasks = new Map<\n      string,\n      Promise<IEntrypointDependency>\n    >(),\n    protected readonly dependencies = new Map<string, IEntrypointDependency>(),\n    generation = 1\n  ) {\n    console.log(\"entrypoint - constructor\")\n    super(services, evaluatedOnly, exports, generation, name, only, parents);\n\n    this.loadedAndParsed =\n      loadedAndParsed ??\n      services.loadAndParseFn(\n        services,\n        name,\n        initialCode,\n        parents[0]?.log ?? services.log\n      );\n\n    if (this.loadedAndParsed.code !== undefined) {\n      services.cache.invalidateIfChanged(name, this.loadedAndParsed.code);\n    }\n\n    const code =\n      this.loadedAndParsed.evaluator === 'ignored'\n        ? '[IGNORED]'\n        : this.originalCode || EMPTY_FILE;\n\n    this.log.extend('source')('created %s (%o)\\n%s', name, only, code);\n  }\n\n  public get ignored() {\n    console.log(\"Entrypoint - get ignored\");\n    return this.loadedAndParsed.evaluator === 'ignored';\n  }\n\n  public get originalCode() {\n    console.log(\"Entrypoint - get originalCode\");\n    return this.loadedAndParsed.code;\n  }\n\n  public get supersededWith(): Entrypoint | null {\n    console.log(\"Entrypoint - get supersededWith\");\n    return this.#supersededWith?.supersededWith ?? this.#supersededWith;\n  }\n\n  public get transformedCode(): string | null {\n    console.log(\"Entrypoint - get transformedCode\");\n    return (\n      this.#transformResultCode ?? this.supersededWith?.transformedCode ?? null\n    );\n  }\n\n  public static createRoot(\n    services: Services,\n    name: string,\n    only: string[],\n    loadedCode: string | undefined\n  ): Entrypoint {\n    console.log(\"Entrypoint - createRoot\");\n    const created = Entrypoint.create(services, null, name, only, loadedCode);\n    invariant(created !== 'loop', 'loop detected');\n\n    return created;\n  }\n\n  /**\n   * Creates an entrypoint for the specified file.\n   * If there is already an entrypoint for this file, there will be four possible outcomes:\n   * 1. If `loadedCode` is specified and is different from the one that was used to create the existing entrypoint,\n   *   the existing entrypoint will be superseded by a new one and all cached results for it will be invalidated.\n   *   It can happen if the file was changed and the watcher notified us about it, or we received a new version\n   *   of the file from a loader whereas the previous one was loaded from the filesystem.\n   *   The new entrypoint will be returned.\n   * 2. If `only` is subset of the existing entrypoint's `only`, the existing entrypoint will be returned.\n   * 3. If `only` is superset of the existing entrypoint's `only`, the existing entrypoint will be superseded and the new one will be returned.\n   * 4. If a loop is detected, 'ignored' will be returned, the existing entrypoint will be superseded or not depending on the `only` value.\n   */\n  protected static create(\n    services: Services,\n    parent: ParentEntrypoint | null,\n    name: string,\n    only: string[],\n    loadedCode: string | undefined\n  ): Entrypoint | 'loop' {\n    console.log(\"Entrypoint - create\");\n    const { cache, eventEmitter } = services;\n    return eventEmitter.perf('createEntrypoint', () => {\n      const [status, entrypoint] = Entrypoint.innerCreate(\n        services,\n        parent\n          ? {\n              evaluated: parent.evaluated,\n              log: parent.log,\n              name: parent.name,\n              parents: parent.parents,\n              seqId: parent.seqId,\n            }\n          : null,\n        name,\n        only,\n        loadedCode\n      );\n\n      if (status !== 'cached') {\n        cache.add('entrypoints', name, entrypoint);\n      }\n\n      return status === 'loop' ? 'loop' : entrypoint;\n    });\n  }\n\n  private static innerCreate(\n    services: Services,\n    parent: ParentEntrypoint | null,\n    name: string,\n    only: string[],\n    loadedCode: string | undefined\n  ): ['loop' | 'created' | 'cached', Entrypoint] {\n    console.log(\"Entrypoint - innerCreate\");\n    const { cache } = services;\n\n    const cached = cache.get('entrypoints', name);\n    const changed =\n      loadedCode !== undefined\n        ? cache.invalidateIfChanged(name, loadedCode)\n        : false;\n\n    if (!cached?.evaluated && cached?.ignored) {\n      return ['cached', cached];\n    }\n\n    const exports = cached?.exports;\n    const evaluatedOnly = cached?.evaluatedOnly ?? [];\n    const mergedOnly =\n      !changed && cached?.only\n        ? mergeOnly(cached.only, only).filter((i) => !evaluatedOnly.includes(i))\n        : only;\n\n    if (cached?.evaluated) {\n      cached.log('is already evaluated with', cached.evaluatedOnly);\n    }\n\n    if (!changed && cached && !cached.evaluated) {\n      const isLoop = parent && hasLoop(name, parent);\n      if (isLoop) {\n        parent.log('[createEntrypoint] %s is a loop', name);\n      }\n\n      if (parent && !cached.parents.map((p) => p.name).includes(parent.name)) {\n        cached.parents.push(parent);\n      }\n\n      if (isSuperSet(cached.only, mergedOnly)) {\n        cached.log('is cached', name);\n        return [isLoop ? 'loop' : 'cached', cached];\n      }\n\n      cached.log(\n        'is cached, but with different `only` %o (the cached one %o)',\n        only,\n        cached?.only\n      );\n\n      return [isLoop ? 'loop' : 'created', cached.supersede(mergedOnly)];\n    }\n\n    const newEntrypoint = new Entrypoint(\n      services,\n      parent ? [parent] : [],\n      loadedCode,\n      name,\n      mergedOnly,\n      exports,\n      evaluatedOnly,\n      undefined,\n      cached && 'resolveTasks' in cached ? cached.resolveTasks : undefined,\n      cached && 'dependencies' in cached ? cached.dependencies : undefined,\n      cached ? cached.generation + 1 : 1\n    );\n\n    if (cached && !cached.evaluated) {\n      cached.log('is cached, but with different code');\n      cached.supersede(newEntrypoint);\n    }\n\n    return ['created', newEntrypoint];\n  }\n\n  public addDependency(dependency: IEntrypointDependency): void {\n    console.log(\"Entrypoint - addDependency\");\n    this.resolveTasks.delete(dependency.source);\n    this.dependencies.set(dependency.source, dependency);\n  }\n\n  public addResolveTask(\n    name: string,\n    dependency: Promise<IEntrypointDependency>\n  ): void {\n    console.log(\"Entrypoint - addResolveTask\");\n    this.resolveTasks.set(name, dependency);\n  }\n\n  public assertNotSuperseded() {\n    console.log(\"Entrypoint - assertNotSuperseded\");\n    if (this.supersededWith) {\n      this.log('superseded');\n      throw new AbortError('superseded');\n    }\n  }\n\n  public assertTransformed() {\n    console.log(\"Entrypoint - assertTransformed\");\n    if (this.transformedCode === null) {\n      this.log('not transformed');\n      throw new UnprocessedEntrypointError(this.supersededWith ?? this);\n    }\n  }\n\n  public createAction<\n    TType extends ActionTypes,\n    TAction extends ActionByType<TType>,\n  >(\n    actionType: TType,\n    data: TAction['data'],\n    abortSignal: AbortSignal | null = null\n  ): BaseAction<TAction> {\n    console.log(\"Entrypoint - createAction\");\n    if (!this.actionsCache.has(actionType)) {\n      this.actionsCache.set(actionType, new Map());\n    }\n\n    const cache = this.actionsCache.get(actionType)!;\n    const cached = cache.get(data);\n    if (cached && !cached.abortSignal?.aborted) {\n      return cached as BaseAction<TAction>;\n    }\n\n    const newAction = new BaseAction<TAction>(\n      actionType as TAction['type'],\n      this.services,\n      this,\n      data,\n      abortSignal\n    );\n\n    cache.set(data, newAction);\n\n    this.services.eventEmitter.entrypointEvent(this.seqId, {\n      type: 'actionCreated',\n      actionType,\n      actionIdx: newAction.idx,\n    });\n\n    return newAction;\n  }\n\n  public createChild(\n    name: string,\n    only: string[],\n    loadedCode?: string\n  ): Entrypoint | 'loop' {\n    console.log(\"Entrypoint - createChild\");\n    return Entrypoint.create(this.services, this, name, only, loadedCode);\n  }\n\n  public createEvaluated() {\n    console.log(\"Entrypoint - createEvaluated\");\n    const evaluatedOnly = mergeOnly(this.evaluatedOnly, this.only);\n    this.log('create EvaluatedEntrypoint for %o', evaluatedOnly);\n\n    return new EvaluatedEntrypoint(\n      this.services,\n      evaluatedOnly,\n      this.exportsProxy,\n      this.generation + 1,\n      this.name,\n      this.only,\n      this.parents\n    );\n  }\n\n  public getDependency(name: string): IEntrypointDependency | undefined {\n    console.log(\"Entrypoint - getDependency\");\n    return this.dependencies.get(name);\n  }\n\n  public getResolveTask(\n    name: string\n  ): Promise<IEntrypointDependency> | undefined {\n    console.log(\"Entrypoint - getResolveTask\");\n    return this.resolveTasks.get(name);\n  }\n\n  public hasWywMetadata() {\n    console.log(\"Entrypoint - hasWywMetadata\");\n    return this.#hasWywMetadata;\n  }\n\n  public onSupersede(callback: (newEntrypoint: Entrypoint) => void) {\n    console.log(\"Entrypoint - onSupersede\");\n    if (this.#supersededWith) {\n      callback(this.#supersededWith);\n      return () => {};\n    }\n\n    this.onSupersedeHandlers.push(callback);\n\n    return () => {\n      const index = this.onSupersedeHandlers.indexOf(callback);\n      if (index >= 0) {\n        this.onSupersedeHandlers.splice(index, 1);\n      }\n    };\n  }\n\n  public setTransformResult(res: ITransformFileResult | null) {\n    console.log(\"Entrypoint - setTransformResult\");\n    this.#hasWywMetadata = Boolean(res?.metadata);\n    this.#transformResultCode = res?.code ?? null;\n\n    this.services.eventEmitter.entrypointEvent(this.seqId, {\n      isNull: res === null,\n      type: 'setTransformResult',\n    });\n  }\n\n  private supersede(newOnlyOrEntrypoint: string[] | Entrypoint): Entrypoint {\n    console.log(\"Entrypoint - supersede\");\n    const newEntrypoint =\n      newOnlyOrEntrypoint instanceof Entrypoint\n        ? newOnlyOrEntrypoint\n        : new Entrypoint(\n            this.services,\n            this.parents,\n            this.initialCode,\n            this.name,\n            newOnlyOrEntrypoint,\n            this.exports,\n            this.evaluatedOnly,\n            this.loadedAndParsed,\n            this.resolveTasks,\n            this.dependencies,\n            this.generation + 1\n          );\n\n    this.services.eventEmitter.entrypointEvent(this.seqId, {\n      type: 'superseded',\n      with: newEntrypoint.seqId,\n    });\n    this.log(\n      'superseded by %s (%o -> %o)',\n      newEntrypoint.name,\n      this.only,\n      newEntrypoint.only\n    );\n    this.#supersededWith = newEntrypoint;\n    this.onSupersedeHandlers.forEach((handler) => handler(newEntrypoint));\n\n    return newEntrypoint;\n  }\n}\n"],"mappings":"AAAA,SAASA,SAAS,QAAQ,cAAc;AAIxC,SAASC,cAAc,QAAQ,kBAAkB;AACjD,SAASC,UAAU,EAAEC,SAAS,QAAQ,sBAAsB;AAM5D,SAASC,mBAAmB,QAAQ,uBAAuB;AAC3D,SAASC,UAAU,QAAQ,sBAAsB;AAEjD,SAASC,UAAU,QAAQ,sBAAsB;AACjD,SAASC,0BAA0B,QAAQ,sCAAsC;AAGjF,MAAMC,UAAU,GAAG,oBAAoB;AAEvC,SAASC,OAAOA,CACdC,IAAY,EACZC,MAAwB,EACxBC,SAAmB,GAAG,EAAE,EACf;EACTC,OAAO,CAACC,GAAG,CAAC,sBAAsB,CAAC;EACnC,IAAIH,MAAM,CAACD,IAAI,KAAKA,IAAI,IAAIE,SAAS,CAACG,QAAQ,CAACJ,MAAM,CAACD,IAAI,CAAC,EAAE;IAC3D,OAAO,IAAI;EACb;EAEA,KAAK,MAAMM,CAAC,IAAIL,MAAM,CAACM,OAAO,EAAE;IAC9B,MAAMC,KAAK,GAAGT,OAAO,CAACC,IAAI,EAAEM,CAAC,EAAE,CAAC,GAAGJ,SAAS,EAAED,MAAM,CAACD,IAAI,CAAC,CAAC;IAC3D,IAAIQ,KAAK,EAAE;MACT,OAAOA,KAAK;IACd;EACF;EAEA,OAAO,KAAK;AACd;AAEA,OAAO,MAAMC,UAAU,SAASlB,cAAc,CAAC;EAC7BmB,SAAS,GAAG,KAAK;EAIvBC,mBAAmB,GAC3B,EAAE;EAEIC,YAAY,GAGhB,IAAIC,GAAG,CAAC,CAAC;EAEb,CAACC,cAAc,GAAY,KAAK;EAEhC,CAACC,cAAc,GAAsB,IAAI;EAEzC,CAACC,mBAAmB,GAAkB,IAAI;EAElCC,WAAWA,CACjBC,QAAkB,EAClBX,OAA2B,EACXY,WAA+B,EAC/CnB,IAAY,EACZoB,IAAc,EACdC,OAAqD,EACrDC,aAAuB,EACvBC,eAAsD,EACnCC,YAAY,GAAG,IAAIX,GAAG,CAGvC,CAAC,EACgBY,YAAY,GAAG,IAAIZ,GAAG,CAAgC,CAAC,EAC1Ea,UAAU,GAAG,CAAC,EACd;IACAvB,OAAO,CAACC,GAAG,CAAC,0BAA0B,CAAC;IACvC,KAAK,CAACc,QAAQ,EAAEI,aAAa,EAAED,OAAO,EAAEK,UAAU,EAAE1B,IAAI,EAAEoB,IAAI,EAAEb,OAAO,CAAC;IAAC,KAdzDY,WAA+B,GAA/BA,WAA+B;IAAA,KAM5BK,YAAY,GAAZA,YAAY;IAAA,KAIZC,YAAY,GAAZA,YAAY;IAM/B,IAAI,CAACF,eAAe,GAClBA,eAAe,IACfL,QAAQ,CAACS,cAAc,CACrBT,QAAQ,EACRlB,IAAI,EACJmB,WAAW,EACXZ,OAAO,CAAC,CAAC,CAAC,EAAEH,GAAG,IAAIc,QAAQ,CAACd,GAC9B,CAAC;IAEH,IAAI,IAAI,CAACmB,eAAe,CAACK,IAAI,KAAKC,SAAS,EAAE;MAC3CX,QAAQ,CAACY,KAAK,CAACC,mBAAmB,CAAC/B,IAAI,EAAE,IAAI,CAACuB,eAAe,CAACK,IAAI,CAAC;IACrE;IAEA,MAAMA,IAAI,GACR,IAAI,CAACL,eAAe,CAACS,SAAS,KAAK,SAAS,GACxC,WAAW,GACX,IAAI,CAACC,YAAY,IAAInC,UAAU;IAErC,IAAI,CAACM,GAAG,CAAC8B,MAAM,CAAC,QAAQ,CAAC,CAAC,qBAAqB,EAAElC,IAAI,EAAEoB,IAAI,EAAEQ,IAAI,CAAC;EACpE;EAEA,IAAWO,OAAOA,CAAA,EAAG;IACnBhC,OAAO,CAACC,GAAG,CAAC,0BAA0B,CAAC;IACvC,OAAO,IAAI,CAACmB,eAAe,CAACS,SAAS,KAAK,SAAS;EACrD;EAEA,IAAWC,YAAYA,CAAA,EAAG;IACxB9B,OAAO,CAACC,GAAG,CAAC,+BAA+B,CAAC;IAC5C,OAAO,IAAI,CAACmB,eAAe,CAACK,IAAI;EAClC;EAEA,IAAWb,cAAcA,CAAA,EAAsB;IAC7CZ,OAAO,CAACC,GAAG,CAAC,iCAAiC,CAAC;IAC9C,OAAO,IAAI,CAAC,CAACW,cAAc,EAAEA,cAAc,IAAI,IAAI,CAAC,CAACA,cAAc;EACrE;EAEA,IAAWqB,eAAeA,CAAA,EAAkB;IAC1CjC,OAAO,CAACC,GAAG,CAAC,kCAAkC,CAAC;IAC/C,OACE,IAAI,CAAC,CAACY,mBAAmB,IAAI,IAAI,CAACD,cAAc,EAAEqB,eAAe,IAAI,IAAI;EAE7E;EAEA,OAAcC,UAAUA,CACtBnB,QAAkB,EAClBlB,IAAY,EACZoB,IAAc,EACdkB,UAA8B,EAClB;IACZnC,OAAO,CAACC,GAAG,CAAC,yBAAyB,CAAC;IACtC,MAAMmC,OAAO,GAAG9B,UAAU,CAAC+B,MAAM,CAACtB,QAAQ,EAAE,IAAI,EAAElB,IAAI,EAAEoB,IAAI,EAAEkB,UAAU,CAAC;IACzEhD,SAAS,CAACiD,OAAO,KAAK,MAAM,EAAE,eAAe,CAAC;IAE9C,OAAOA,OAAO;EAChB;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACE,OAAiBC,MAAMA,CACrBtB,QAAkB,EAClBjB,MAA+B,EAC/BD,IAAY,EACZoB,IAAc,EACdkB,UAA8B,EACT;IACrBnC,OAAO,CAACC,GAAG,CAAC,qBAAqB,CAAC;IAClC,MAAM;MAAE0B,KAAK;MAAEW;IAAa,CAAC,GAAGvB,QAAQ;IACxC,OAAOuB,YAAY,CAACC,IAAI,CAAC,kBAAkB,EAAE,MAAM;MACjD,MAAM,CAACC,MAAM,EAAEC,UAAU,CAAC,GAAGnC,UAAU,CAACoC,WAAW,CACjD3B,QAAQ,EACRjB,MAAM,GACF;QACES,SAAS,EAAET,MAAM,CAACS,SAAS;QAC3BN,GAAG,EAAEH,MAAM,CAACG,GAAG;QACfJ,IAAI,EAAEC,MAAM,CAACD,IAAI;QACjBO,OAAO,EAAEN,MAAM,CAACM,OAAO;QACvBuC,KAAK,EAAE7C,MAAM,CAAC6C;MAChB,CAAC,GACD,IAAI,EACR9C,IAAI,EACJoB,IAAI,EACJkB,UACF,CAAC;MAED,IAAIK,MAAM,KAAK,QAAQ,EAAE;QACvBb,KAAK,CAACiB,GAAG,CAAC,aAAa,EAAE/C,IAAI,EAAE4C,UAAU,CAAC;MAC5C;MAEA,OAAOD,MAAM,KAAK,MAAM,GAAG,MAAM,GAAGC,UAAU;IAChD,CAAC,CAAC;EACJ;EAEA,OAAeC,WAAWA,CACxB3B,QAAkB,EAClBjB,MAA+B,EAC/BD,IAAY,EACZoB,IAAc,EACdkB,UAA8B,EACe;IAC7CnC,OAAO,CAACC,GAAG,CAAC,0BAA0B,CAAC;IACvC,MAAM;MAAE0B;IAAM,CAAC,GAAGZ,QAAQ;IAE1B,MAAM8B,MAAM,GAAGlB,KAAK,CAACmB,GAAG,CAAC,aAAa,EAAEjD,IAAI,CAAC;IAC7C,MAAMkD,OAAO,GACXZ,UAAU,KAAKT,SAAS,GACpBC,KAAK,CAACC,mBAAmB,CAAC/B,IAAI,EAAEsC,UAAU,CAAC,GAC3C,KAAK;IAEX,IAAI,CAACU,MAAM,EAAEtC,SAAS,IAAIsC,MAAM,EAAEb,OAAO,EAAE;MACzC,OAAO,CAAC,QAAQ,EAAEa,MAAM,CAAC;IAC3B;IAEA,MAAM3B,OAAO,GAAG2B,MAAM,EAAE3B,OAAO;IAC/B,MAAMC,aAAa,GAAG0B,MAAM,EAAE1B,aAAa,IAAI,EAAE;IACjD,MAAM6B,UAAU,GACd,CAACD,OAAO,IAAIF,MAAM,EAAE5B,IAAI,GACpB3B,SAAS,CAACuD,MAAM,CAAC5B,IAAI,EAAEA,IAAI,CAAC,CAACgC,MAAM,CAAEC,CAAC,IAAK,CAAC/B,aAAa,CAACjB,QAAQ,CAACgD,CAAC,CAAC,CAAC,GACtEjC,IAAI;IAEV,IAAI4B,MAAM,EAAEtC,SAAS,EAAE;MACrBsC,MAAM,CAAC5C,GAAG,CAAC,2BAA2B,EAAE4C,MAAM,CAAC1B,aAAa,CAAC;IAC/D;IAEA,IAAI,CAAC4B,OAAO,IAAIF,MAAM,IAAI,CAACA,MAAM,CAACtC,SAAS,EAAE;MAC3C,MAAM4C,MAAM,GAAGrD,MAAM,IAAIF,OAAO,CAACC,IAAI,EAAEC,MAAM,CAAC;MAC9C,IAAIqD,MAAM,EAAE;QACVrD,MAAM,CAACG,GAAG,CAAC,iCAAiC,EAAEJ,IAAI,CAAC;MACrD;MAEA,IAAIC,MAAM,IAAI,CAAC+C,MAAM,CAACzC,OAAO,CAACgD,GAAG,CAAEjD,CAAC,IAAKA,CAAC,CAACN,IAAI,CAAC,CAACK,QAAQ,CAACJ,MAAM,CAACD,IAAI,CAAC,EAAE;QACtEgD,MAAM,CAACzC,OAAO,CAACiD,IAAI,CAACvD,MAAM,CAAC;MAC7B;MAEA,IAAIT,UAAU,CAACwD,MAAM,CAAC5B,IAAI,EAAE+B,UAAU,CAAC,EAAE;QACvCH,MAAM,CAAC5C,GAAG,CAAC,WAAW,EAAEJ,IAAI,CAAC;QAC7B,OAAO,CAACsD,MAAM,GAAG,MAAM,GAAG,QAAQ,EAAEN,MAAM,CAAC;MAC7C;MAEAA,MAAM,CAAC5C,GAAG,CACR,6DAA6D,EAC7DgB,IAAI,EACJ4B,MAAM,EAAE5B,IACV,CAAC;MAED,OAAO,CAACkC,MAAM,GAAG,MAAM,GAAG,SAAS,EAAEN,MAAM,CAACS,SAAS,CAACN,UAAU,CAAC,CAAC;IACpE;IAEA,MAAMO,aAAa,GAAG,IAAIjD,UAAU,CAClCS,QAAQ,EACRjB,MAAM,GAAG,CAACA,MAAM,CAAC,GAAG,EAAE,EACtBqC,UAAU,EACVtC,IAAI,EACJmD,UAAU,EACV9B,OAAO,EACPC,aAAa,EACbO,SAAS,EACTmB,MAAM,IAAI,cAAc,IAAIA,MAAM,GAAGA,MAAM,CAACxB,YAAY,GAAGK,SAAS,EACpEmB,MAAM,IAAI,cAAc,IAAIA,MAAM,GAAGA,MAAM,CAACvB,YAAY,GAAGI,SAAS,EACpEmB,MAAM,GAAGA,MAAM,CAACtB,UAAU,GAAG,CAAC,GAAG,CACnC,CAAC;IAED,IAAIsB,MAAM,IAAI,CAACA,MAAM,CAACtC,SAAS,EAAE;MAC/BsC,MAAM,CAAC5C,GAAG,CAAC,oCAAoC,CAAC;MAChD4C,MAAM,CAACS,SAAS,CAACC,aAAa,CAAC;IACjC;IAEA,OAAO,CAAC,SAAS,EAAEA,aAAa,CAAC;EACnC;EAEOC,aAAaA,CAACC,UAAiC,EAAQ;IAC5DzD,OAAO,CAACC,GAAG,CAAC,4BAA4B,CAAC;IACzC,IAAI,CAACoB,YAAY,CAACqC,MAAM,CAACD,UAAU,CAACE,MAAM,CAAC;IAC3C,IAAI,CAACrC,YAAY,CAACsC,GAAG,CAACH,UAAU,CAACE,MAAM,EAAEF,UAAU,CAAC;EACtD;EAEOI,cAAcA,CACnBhE,IAAY,EACZ4D,UAA0C,EACpC;IACNzD,OAAO,CAACC,GAAG,CAAC,6BAA6B,CAAC;IAC1C,IAAI,CAACoB,YAAY,CAACuC,GAAG,CAAC/D,IAAI,EAAE4D,UAAU,CAAC;EACzC;EAEOK,mBAAmBA,CAAA,EAAG;IAC3B9D,OAAO,CAACC,GAAG,CAAC,kCAAkC,CAAC;IAC/C,IAAI,IAAI,CAACW,cAAc,EAAE;MACvB,IAAI,CAACX,GAAG,CAAC,YAAY,CAAC;MACtB,MAAM,IAAIT,UAAU,CAAC,YAAY,CAAC;IACpC;EACF;EAEOuE,iBAAiBA,CAAA,EAAG;IACzB/D,OAAO,CAACC,GAAG,CAAC,gCAAgC,CAAC;IAC7C,IAAI,IAAI,CAACgC,eAAe,KAAK,IAAI,EAAE;MACjC,IAAI,CAAChC,GAAG,CAAC,iBAAiB,CAAC;MAC3B,MAAM,IAAIP,0BAA0B,CAAC,IAAI,CAACkB,cAAc,IAAI,IAAI,CAAC;IACnE;EACF;EAEOoD,YAAYA,CAIjBC,UAAiB,EACjBC,IAAqB,EACrBC,WAA+B,GAAG,IAAI,EACjB;IACrBnE,OAAO,CAACC,GAAG,CAAC,2BAA2B,CAAC;IACxC,IAAI,CAAC,IAAI,CAACQ,YAAY,CAAC2D,GAAG,CAACH,UAAU,CAAC,EAAE;MACtC,IAAI,CAACxD,YAAY,CAACmD,GAAG,CAACK,UAAU,EAAE,IAAIvD,GAAG,CAAC,CAAC,CAAC;IAC9C;IAEA,MAAMiB,KAAK,GAAG,IAAI,CAAClB,YAAY,CAACqC,GAAG,CAACmB,UAAU,CAAE;IAChD,MAAMpB,MAAM,GAAGlB,KAAK,CAACmB,GAAG,CAACoB,IAAI,CAAC;IAC9B,IAAIrB,MAAM,IAAI,CAACA,MAAM,CAACsB,WAAW,EAAEE,OAAO,EAAE;MAC1C,OAAOxB,MAAM;IACf;IAEA,MAAMyB,SAAS,GAAG,IAAI7E,UAAU,CAC9BwE,UAAU,EACV,IAAI,CAAClD,QAAQ,EACb,IAAI,EACJmD,IAAI,EACJC,WACF,CAAC;IAEDxC,KAAK,CAACiC,GAAG,CAACM,IAAI,EAAEI,SAAS,CAAC;IAE1B,IAAI,CAACvD,QAAQ,CAACuB,YAAY,CAACiC,eAAe,CAAC,IAAI,CAAC5B,KAAK,EAAE;MACrD6B,IAAI,EAAE,eAAe;MACrBP,UAAU;MACVQ,SAAS,EAAEH,SAAS,CAACI;IACvB,CAAC,CAAC;IAEF,OAAOJ,SAAS;EAClB;EAEOK,WAAWA,CAChB9E,IAAY,EACZoB,IAAc,EACdkB,UAAmB,EACE;IACrBnC,OAAO,CAACC,GAAG,CAAC,0BAA0B,CAAC;IACvC,OAAOK,UAAU,CAAC+B,MAAM,CAAC,IAAI,CAACtB,QAAQ,EAAE,IAAI,EAAElB,IAAI,EAAEoB,IAAI,EAAEkB,UAAU,CAAC;EACvE;EAEOyC,eAAeA,CAAA,EAAG;IACvB5E,OAAO,CAACC,GAAG,CAAC,8BAA8B,CAAC;IAC3C,MAAMkB,aAAa,GAAG7B,SAAS,CAAC,IAAI,CAAC6B,aAAa,EAAE,IAAI,CAACF,IAAI,CAAC;IAC9D,IAAI,CAAChB,GAAG,CAAC,mCAAmC,EAAEkB,aAAa,CAAC;IAE5D,OAAO,IAAI5B,mBAAmB,CAC5B,IAAI,CAACwB,QAAQ,EACbI,aAAa,EACb,IAAI,CAAC0D,YAAY,EACjB,IAAI,CAACtD,UAAU,GAAG,CAAC,EACnB,IAAI,CAAC1B,IAAI,EACT,IAAI,CAACoB,IAAI,EACT,IAAI,CAACb,OACP,CAAC;EACH;EAEO0E,aAAaA,CAACjF,IAAY,EAAqC;IACpEG,OAAO,CAACC,GAAG,CAAC,4BAA4B,CAAC;IACzC,OAAO,IAAI,CAACqB,YAAY,CAACwB,GAAG,CAACjD,IAAI,CAAC;EACpC;EAEOkF,cAAcA,CACnBlF,IAAY,EACgC;IAC5CG,OAAO,CAACC,GAAG,CAAC,6BAA6B,CAAC;IAC1C,OAAO,IAAI,CAACoB,YAAY,CAACyB,GAAG,CAACjD,IAAI,CAAC;EACpC;EAEOc,cAAcA,CAAA,EAAG;IACtBX,OAAO,CAACC,GAAG,CAAC,6BAA6B,CAAC;IAC1C,OAAO,IAAI,CAAC,CAACU,cAAc;EAC7B;EAEOqE,WAAWA,CAACC,QAA6C,EAAE;IAChEjF,OAAO,CAACC,GAAG,CAAC,0BAA0B,CAAC;IACvC,IAAI,IAAI,CAAC,CAACW,cAAc,EAAE;MACxBqE,QAAQ,CAAC,IAAI,CAAC,CAACrE,cAAc,CAAC;MAC9B,OAAO,MAAM,CAAC,CAAC;IACjB;IAEA,IAAI,CAACJ,mBAAmB,CAAC6C,IAAI,CAAC4B,QAAQ,CAAC;IAEvC,OAAO,MAAM;MACX,MAAMC,KAAK,GAAG,IAAI,CAAC1E,mBAAmB,CAAC2E,OAAO,CAACF,QAAQ,CAAC;MACxD,IAAIC,KAAK,IAAI,CAAC,EAAE;QACd,IAAI,CAAC1E,mBAAmB,CAAC4E,MAAM,CAACF,KAAK,EAAE,CAAC,CAAC;MAC3C;IACF,CAAC;EACH;EAEOG,kBAAkBA,CAACC,GAAgC,EAAE;IAC1DtF,OAAO,CAACC,GAAG,CAAC,iCAAiC,CAAC;IAC9C,IAAI,CAAC,CAACU,cAAc,GAAG4E,OAAO,CAACD,GAAG,EAAEE,QAAQ,CAAC;IAC7C,IAAI,CAAC,CAAC3E,mBAAmB,GAAGyE,GAAG,EAAE7D,IAAI,IAAI,IAAI;IAE7C,IAAI,CAACV,QAAQ,CAACuB,YAAY,CAACiC,eAAe,CAAC,IAAI,CAAC5B,KAAK,EAAE;MACrD8C,MAAM,EAAEH,GAAG,KAAK,IAAI;MACpBd,IAAI,EAAE;IACR,CAAC,CAAC;EACJ;EAEQlB,SAASA,CAACoC,mBAA0C,EAAc;IACxE1F,OAAO,CAACC,GAAG,CAAC,wBAAwB,CAAC;IACrC,MAAMsD,aAAa,GACjBmC,mBAAmB,YAAYpF,UAAU,GACrCoF,mBAAmB,GACnB,IAAIpF,UAAU,CACZ,IAAI,CAACS,QAAQ,EACb,IAAI,CAACX,OAAO,EACZ,IAAI,CAACY,WAAW,EAChB,IAAI,CAACnB,IAAI,EACT6F,mBAAmB,EACnB,IAAI,CAACxE,OAAO,EACZ,IAAI,CAACC,aAAa,EAClB,IAAI,CAACC,eAAe,EACpB,IAAI,CAACC,YAAY,EACjB,IAAI,CAACC,YAAY,EACjB,IAAI,CAACC,UAAU,GAAG,CACpB,CAAC;IAEP,IAAI,CAACR,QAAQ,CAACuB,YAAY,CAACiC,eAAe,CAAC,IAAI,CAAC5B,KAAK,EAAE;MACrD6B,IAAI,EAAE,YAAY;MAClBmB,IAAI,EAAEpC,aAAa,CAACZ;IACtB,CAAC,CAAC;IACF,IAAI,CAAC1C,GAAG,CACN,6BAA6B,EAC7BsD,aAAa,CAAC1D,IAAI,EAClB,IAAI,CAACoB,IAAI,EACTsC,aAAa,CAACtC,IAChB,CAAC;IACD,IAAI,CAAC,CAACL,cAAc,GAAG2C,aAAa;IACpC,IAAI,CAAC/C,mBAAmB,CAACoF,OAAO,CAAEC,OAAO,IAAKA,OAAO,CAACtC,aAAa,CAAC,CAAC;IAErE,OAAOA,aAAa;EACtB;AACF","ignoreList":[]}