{"version":3,"file":"collector.js","names":["logger","EventEmitter","applyProcessors","removeWithRelated","invalidateTraversalCache","filename","__filename","collector","file","options","values","console","log","eventEmitter","dummy","processors","perf","path","opts","processor","build","doRuntimeReplacement","push","length","prevalExport","scope","getData","findParent","p","isExpressionStatement","collectorPlugin","babel","Map","debug","extend","name","pre","metadata","wywInJS","replacements","rules","dependencies","visitor","post"],"sources":["../../src/plugins/collector.ts"],"sourcesContent":["/**\n * Collector traverses the AST and collects information about imports and\n * all usages of WYW-processors.\n */\n\nimport type { BabelFile, PluginObj } from '@babel/core';\nimport type { NodePath } from '@babel/traverse';\n\nimport type { ValueCache } from '@wyw-in-js/processor-utils';\nimport { logger } from '@wyw-in-js/shared';\nimport type { StrictOptions } from '@wyw-in-js/shared';\n\nimport { EventEmitter } from '../utils/EventEmitter';\nimport { applyProcessors } from '../utils/getTagProcessor';\nimport type { Core } from '../babel';\nimport type { IPluginState } from '../types';\nimport type { WYWTransformMetadata } from '../utils/TransformMetadata';\nimport { removeWithRelated } from '../utils/scopeHelpers';\nimport { invalidateTraversalCache } from '../utils/traversalCache';\n\nexport const filename = __filename;\n\nexport function collector(\n  file: BabelFile,\n  options: Pick<\n    StrictOptions,\n    'classNameSlug' | 'displayName' | 'evaluate' | 'tagResolver'\n  > & { eventEmitter?: EventEmitter },\n  values: ValueCache\n) {\n  console.log(\"collector - collector\");\n  const eventEmitter = options.eventEmitter ?? EventEmitter.dummy;\n  const processors: WYWTransformMetadata['processors'] = [];\n\n  eventEmitter.perf('transform:collector:processTemplate', () => {\n    applyProcessors(file.path, file.opts, options, (processor) => {\n      processor.build(values);\n      processor.doRuntimeReplacement();\n      processors.push(processor);\n    });\n  });\n\n  if (processors.length === 0) {\n    // We didn't find any processors.\n    return processors;\n  }\n\n  // We can remove __wywPreval export and all related code\n  const prevalExport = (\n    file.path.scope.getData('__wywPreval') as NodePath | undefined\n  )?.findParent((p) => p.isExpressionStatement());\n  if (prevalExport) {\n    removeWithRelated([prevalExport]);\n  }\n\n  return processors;\n}\n\nexport default function collectorPlugin(\n  babel: Core,\n  options: StrictOptions & { eventEmitter?: EventEmitter; values?: ValueCache }\n): PluginObj<IPluginState> {\n  console.log(\"collector - collectorPlugin\");\n  const values = options.values ?? new Map<string, unknown>();\n  const debug = logger.extend('collector');\n  return {\n    name: '@wyw-in-js/transform/collector',\n    pre(file: BabelFile) {\n      debug('start %s', file.opts.filename);\n\n      const processors = collector(file, options, values);\n\n      if (processors.length === 0) {\n        // We didn't find any wyw-in-js template literals.\n        return;\n      }\n\n      this.file.metadata.wywInJS = {\n        processors,\n        replacements: [],\n        rules: {},\n        dependencies: [],\n      };\n\n      debug('end %s', file.opts.filename);\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      invalidateTraversalCache(file.path);\n    },\n  };\n}\n"],"mappings":"AAAA;AACA;AACA;AACA;;AAMA,SAASA,MAAM,QAAQ,mBAAmB;AAG1C,SAASC,YAAY,QAAQ,uBAAuB;AACpD,SAASC,eAAe,QAAQ,0BAA0B;AAI1D,SAASC,iBAAiB,QAAQ,uBAAuB;AACzD,SAASC,wBAAwB,QAAQ,yBAAyB;AAElE,OAAO,MAAMC,QAAQ,GAAGC,UAAU;AAElC,OAAO,SAASC,SAASA,CACvBC,IAAe,EACfC,OAGmC,EACnCC,MAAkB,EAClB;EACAC,OAAO,CAACC,GAAG,CAAC,uBAAuB,CAAC;EACpC,MAAMC,YAAY,GAAGJ,OAAO,CAACI,YAAY,IAAIZ,YAAY,CAACa,KAAK;EAC/D,MAAMC,UAA8C,GAAG,EAAE;EAEzDF,YAAY,CAACG,IAAI,CAAC,qCAAqC,EAAE,MAAM;IAC7Dd,eAAe,CAACM,IAAI,CAACS,IAAI,EAAET,IAAI,CAACU,IAAI,EAAET,OAAO,EAAGU,SAAS,IAAK;MAC5DA,SAAS,CAACC,KAAK,CAACV,MAAM,CAAC;MACvBS,SAAS,CAACE,oBAAoB,CAAC,CAAC;MAChCN,UAAU,CAACO,IAAI,CAACH,SAAS,CAAC;IAC5B,CAAC,CAAC;EACJ,CAAC,CAAC;EAEF,IAAIJ,UAAU,CAACQ,MAAM,KAAK,CAAC,EAAE;IAC3B;IACA,OAAOR,UAAU;EACnB;;EAEA;EACA,MAAMS,YAAY,GAChBhB,IAAI,CAACS,IAAI,CAACQ,KAAK,CAACC,OAAO,CAAC,aAAa,CAAC,EACrCC,UAAU,CAAEC,CAAC,IAAKA,CAAC,CAACC,qBAAqB,CAAC,CAAC,CAAC;EAC/C,IAAIL,YAAY,EAAE;IAChBrB,iBAAiB,CAAC,CAACqB,YAAY,CAAC,CAAC;EACnC;EAEA,OAAOT,UAAU;AACnB;AAEA,eAAe,SAASe,eAAeA,CACrCC,KAAW,EACXtB,OAA6E,EACpD;EACzBE,OAAO,CAACC,GAAG,CAAC,6BAA6B,CAAC;EAC1C,MAAMF,MAAM,GAAGD,OAAO,CAACC,MAAM,IAAI,IAAIsB,GAAG,CAAkB,CAAC;EAC3D,MAAMC,KAAK,GAAGjC,MAAM,CAACkC,MAAM,CAAC,WAAW,CAAC;EACxC,OAAO;IACLC,IAAI,EAAE,gCAAgC;IACtCC,GAAGA,CAAC5B,IAAe,EAAE;MACnByB,KAAK,CAAC,UAAU,EAAEzB,IAAI,CAACU,IAAI,CAACb,QAAQ,CAAC;MAErC,MAAMU,UAAU,GAAGR,SAAS,CAACC,IAAI,EAAEC,OAAO,EAAEC,MAAM,CAAC;MAEnD,IAAIK,UAAU,CAACQ,MAAM,KAAK,CAAC,EAAE;QAC3B;QACA;MACF;MAEA,IAAI,CAACf,IAAI,CAAC6B,QAAQ,CAACC,OAAO,GAAG;QAC3BvB,UAAU;QACVwB,YAAY,EAAE,EAAE;QAChBC,KAAK,EAAE,CAAC,CAAC;QACTC,YAAY,EAAE;MAChB,CAAC;MAEDR,KAAK,CAAC,QAAQ,EAAEzB,IAAI,CAACU,IAAI,CAACb,QAAQ,CAAC;IACrC,CAAC;IACDqC,OAAO,EAAE,CAAC,CAAC;IACXC,IAAIA,CAACnC,IAAe,EAAE;MACpBJ,wBAAwB,CAACI,IAAI,CAACS,IAAI,CAAC;IACrC;EACF,CAAC;AACH","ignoreList":[]}