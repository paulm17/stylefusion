{"version":3,"file":"createVmContext.js","names":["vm","isFeatureEnabled","process","NOOP","createWindow","console","log","Window","GlobalWindow","require","HappyWindow","win","Buffer","Uint8Array","createBaseContext","additionalContext","baseContext","document","window","self","top","parent","global","clearImmediate","clearInterval","clearTimeout","setImmediate","requestAnimationFrame","setInterval","setTimeout","key","createHappyDOMWindow","teardown","happyDOM","cancelAsync","createNothing","undefined","createVmContext","filename","features","overrideContext","i","isHappyDOMEnabled","__filename","context","createContext"],"sources":["../../src/vm/createVmContext.ts"],"sourcesContent":["import * as vm from 'vm';\n\nimport type { Window } from 'happy-dom';\n\nimport type { FeatureFlags, StrictOptions } from '@wyw-in-js/shared';\nimport { isFeatureEnabled } from '@wyw-in-js/shared';\n\nimport * as process from './process';\n\nconst NOOP = () => {};\n\nfunction createWindow(): Window {\n  console.log(\"createVmContext - createWindow\");\n  const { Window, GlobalWindow } = require('happy-dom');\n  const HappyWindow = GlobalWindow || Window;\n  const win = new HappyWindow();\n\n  // TODO: browser doesn't expose Buffer, but a lot of dependencies use it\n  win.Buffer = Buffer;\n  win.Uint8Array = Uint8Array;\n\n  return win;\n}\n\nfunction createBaseContext(\n  win: Window | undefined,\n  additionalContext: Partial<vm.Context>\n): Partial<vm.Context> {\n  console.log(\"createVmContext - createBaseContext\");\n  const baseContext: vm.Context = win ?? {};\n\n  baseContext.document = win?.document;\n  baseContext.window = win;\n  baseContext.self = win;\n  baseContext.top = win;\n  baseContext.parent = win;\n  baseContext.global = win;\n\n  baseContext.process = process;\n\n  baseContext.clearImmediate = NOOP;\n  baseContext.clearInterval = NOOP;\n  baseContext.clearTimeout = NOOP;\n  baseContext.setImmediate = NOOP;\n  baseContext.requestAnimationFrame = NOOP;\n  baseContext.setInterval = NOOP;\n  baseContext.setTimeout = NOOP;\n\n  // eslint-disable-next-line guard-for-in,no-restricted-syntax\n  for (const key in additionalContext) {\n    baseContext[key] = additionalContext[key];\n  }\n\n  return baseContext;\n}\n\nfunction createHappyDOMWindow() {\n  console.log(\"createVmContext - createHappyDOMWindow\");\n  const win = createWindow();\n\n  return {\n    teardown: () => {\n      win.happyDOM.cancelAsync();\n    },\n    window: win,\n  };\n}\n\nfunction createNothing() {\n  console.log(\"createVmContext - createNothing\");\n  return {\n    teardown: () => {},\n    window: undefined,\n  };\n}\n\nexport function createVmContext(\n  filename: string,\n  features: FeatureFlags<'happyDOM'>,\n  additionalContext: Partial<vm.Context>,\n  overrideContext: StrictOptions['overrideContext'] = (i) => i\n) {\n  console.log(\"createVmContext - createVmContext\");\n  const isHappyDOMEnabled = isFeatureEnabled(features, 'happyDOM', filename);\n\n  const { teardown, window } = isHappyDOMEnabled\n    ? createHappyDOMWindow()\n    : createNothing();\n  const baseContext = createBaseContext(\n    window,\n    overrideContext(\n      {\n        __filename: filename,\n        ...additionalContext,\n      },\n      filename\n    )\n  );\n\n  const context = vm.createContext(baseContext);\n\n  return {\n    context,\n    teardown,\n  };\n}\n"],"mappings":"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","ignoreList":[]}