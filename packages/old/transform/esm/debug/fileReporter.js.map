{"version":3,"file":"fileReporter.js","names":["createWriteStream","existsSync","mkdirSync","path","EventEmitter","isOnActionStartArgs","workingDir","process","cwd","replacer","_key","value","isAbsolute","relative","Map","Array","from","entries","reduce","obj","k","v","key","printTimings","timings","startedAt","sourceRoot","size","console","log","performance","now","toFixed","forEach","label","byLabel","array","sort","a","b","localeCompare","time","name","startsWith","writeJSONl","stream","data","write","JSON","stringify","createFileReporter","options","dir","emitter","dummy","onDone","reportFolder","recursive","Error","actionStream","join","dependenciesStream","entrypointStream","addTiming","has","set","forLabel","get","Math","round","processDependencyEvent","file","only","imports","fileIdx","processSingleEvent","meta","type","startTimes","onEvent","Object","startTime","String","actionId","onAction","args","timestamp","idx","entrypointRef","result","id","isAsync","error","finishedAt","onEntrypointEvent","emitterId","event","print","memoryUsage","end","clear"],"sources":["../../src/debug/fileReporter.ts"],"sourcesContent":["/* eslint-disable no-console */\nimport { createWriteStream, existsSync, mkdirSync } from 'fs';\nimport path from 'path';\n\nimport type {\n  OnAction,\n  OnEvent,\n  OnActionFinishArgs,\n  OnActionStartArgs,\n  OnEntrypointEvent,\n} from '../utils/EventEmitter';\nimport { EventEmitter, isOnActionStartArgs } from '../utils/EventEmitter';\n\ntype Timings = Map<string, Map<string, number>>;\n\nexport interface IFileReporterOptions {\n  dir?: string;\n  print?: boolean;\n}\n\nexport interface IProcessedEvent {\n  file: string;\n  fileIdx: string;\n  imports: { from: string; what: string[] }[];\n  only: string[];\n  type: 'dependency';\n}\n\nexport interface IQueueActionEvent {\n  action: string;\n  args?: string[];\n  datetime: Date;\n  file: string;\n  queueIdx: string;\n  type: 'queue-action';\n}\n\nconst workingDir = process.cwd();\n\nfunction replacer(_key: string, value: unknown): unknown {\n  if (typeof value === 'string' && path.isAbsolute(value)) {\n    return path.relative(workingDir, value);\n  }\n\n  if (value instanceof Map) {\n    return Array.from(value.entries()).reduce((obj, [k, v]) => {\n      const key = replacer(k, k) as string;\n      return {\n        ...obj,\n        [key]: replacer(key, v),\n      };\n    }, {});\n  }\n\n  return value;\n}\n\nfunction printTimings(timings: Timings, startedAt: number, sourceRoot: string) {\n  if (timings.size === 0) {\n    return;\n  }\n\n  console.log(`\\nTimings:`);\n  console.log(`  Total: ${(performance.now() - startedAt).toFixed()}ms`);\n\n  Array.from(timings.entries()).forEach(([label, byLabel]) => {\n    console.log(`\\n  By ${label}:`);\n\n    const array = Array.from(byLabel.entries());\n    // array.sort(([, a], [, b]) => b - a);\n    array\n      .sort(([a], [b]) => a.localeCompare(b))\n      .forEach(([value, time]) => {\n        const name = value.startsWith(sourceRoot)\n          ? path.relative(sourceRoot, value)\n          : value;\n        console.log(`    ${name}: ${time}ms`);\n      });\n  });\n}\n\nconst writeJSONl = (stream: NodeJS.WritableStream, data: unknown) => {\n  stream.write(`${JSON.stringify(data, replacer)}\\n`);\n};\n\nexport const createFileReporter = (\n  options: IFileReporterOptions | false = false\n) => {\n  if (!options || !options.dir) {\n    return {\n      emitter: EventEmitter.dummy,\n      onDone: () => {},\n    };\n  }\n\n  const reportFolder = existsSync(options.dir)\n    ? options.dir\n    : mkdirSync(options.dir, {\n        recursive: true,\n      });\n\n  if (!reportFolder) {\n    throw new Error(`Could not create directory ${options.dir}`);\n  }\n\n  const actionStream = createWriteStream(\n    path.join(options.dir, 'actions.jsonl')\n  );\n\n  const dependenciesStream = createWriteStream(\n    path.join(options.dir, 'dependencies.jsonl')\n  );\n\n  const entrypointStream = createWriteStream(\n    path.join(options.dir, 'entrypoints.jsonl')\n  );\n\n  const startedAt = performance.now();\n  const timings: Timings = new Map();\n  const addTiming = (label: string, key: string, value: number) => {\n    if (!timings.has(label)) {\n      timings.set(label, new Map());\n    }\n\n    const forLabel = timings.get(label)!;\n    forLabel.set(key, Math.round((forLabel.get(key) || 0) + value));\n  };\n\n  const processDependencyEvent = ({\n    file,\n    only,\n    imports,\n    fileIdx,\n  }: IProcessedEvent) => {\n    writeJSONl(dependenciesStream, {\n      file,\n      only,\n      imports,\n      fileIdx,\n    });\n  };\n\n  const processSingleEvent = (\n    meta: Record<string, unknown> | IProcessedEvent | IQueueActionEvent\n  ) => {\n    if (meta.type === 'dependency') {\n      processDependencyEvent(meta as IProcessedEvent);\n    }\n  };\n\n  const startTimes = new Map<string, number>();\n\n  const onEvent: OnEvent = (meta, type) => {\n    if (type === 'single') {\n      processSingleEvent(meta);\n      return;\n    }\n\n    if (type === 'start') {\n      Object.entries(meta).forEach(([label, value]) => {\n        startTimes.set(`${label}\\0${value}`, performance.now());\n      });\n    } else {\n      Object.entries(meta).forEach(([label, value]) => {\n        const startTime = startTimes.get(`${label}\\0${value}`);\n        if (startTime) {\n          addTiming(label, String(value), performance.now() - startTime);\n        }\n      });\n    }\n  };\n\n  let actionId = 0;\n  const onAction: OnAction = (\n    ...args: OnActionStartArgs | OnActionFinishArgs\n  ) => {\n    if (isOnActionStartArgs(args)) {\n      const [, timestamp, type, idx, entrypointRef] = args;\n      writeJSONl(actionStream, {\n        actionId,\n        entrypointRef,\n        idx,\n        startedAt: timestamp,\n        type,\n      });\n\n      // eslint-disable-next-line no-plusplus\n      return actionId++;\n    }\n\n    const [result, timestamp, id, isAsync, error] = args;\n    writeJSONl(actionStream, {\n      actionId: id,\n      error,\n      finishedAt: timestamp,\n      isAsync,\n      result: `${result}ed`,\n    });\n\n    return id;\n  };\n\n  const onEntrypointEvent: OnEntrypointEvent = (\n    emitterId,\n    timestamp,\n    event\n  ) => {\n    entrypointStream.write(\n      `${JSON.stringify([emitterId, timestamp, event])}\\n`\n    );\n  };\n\n  const emitter = new EventEmitter(onEvent, onAction, onEntrypointEvent);\n\n  return {\n    emitter,\n    onDone: (sourceRoot: string) => {\n      if (options.print) {\n        printTimings(timings, startedAt, sourceRoot);\n\n        console.log('\\nMemory usage:', process.memoryUsage());\n      }\n\n      actionStream.end();\n      dependenciesStream.end();\n      timings.clear();\n    },\n  };\n};\n"],"mappings":"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","ignoreList":[]}