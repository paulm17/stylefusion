{"version":3,"file":"removeDangerousCode.js","names":["nonType","isUnnecessaryReactCall","applyAction","removeWithRelated","JSXElementsRemover","isGlobal","id","console","log","scope","name","node","hasBinding","hasGlobal","ssrCheckFields","Set","forbiddenGlobals","isBrowserGlobal","has","isSSRCheckField","getPropertyName","path","isIdentifier","isStringLiteral","value","removeDangerousCode","programPath","traverse","CallExpression","enter","p","JSXElement","JSXFragment","MemberExpression","state","obj","get","prop","windowScoped","add","globals","filter","MetaProperty","Identifier","find","parent","isTSTypeReference","parentPath","isUnaryExpression","operator","isTSTypeQuery","isClassProperty","isMemberExpression","key","push","UnaryExpression","arg","type"],"sources":["../../src/utils/removeDangerousCode.ts"],"sourcesContent":["import type { NodePath } from '@babel/core';\nimport type { Identifier, Program } from '@babel/types';\n\nimport { nonType } from './findIdentifiers';\nimport { isUnnecessaryReactCall } from './isUnnecessaryReactCall';\nimport { applyAction, removeWithRelated } from './scopeHelpers';\nimport { JSXElementsRemover } from './visitors/JSXElementsRemover';\n\nconst isGlobal = (id: NodePath<Identifier>): boolean => {\n  console.log(\"removeDangerousCode - isGlobal\");\n  if (!nonType(id)) {\n    return false;\n  }\n\n  const { scope } = id;\n  const { name } = id.node;\n  return !scope.hasBinding(name) && scope.hasGlobal(name);\n};\n\nconst ssrCheckFields = new Set([\n  'document',\n  'location',\n  'navigator',\n  'sessionStorage',\n  'localStorage',\n  'window',\n]);\n\nconst forbiddenGlobals = new Set([\n  ...ssrCheckFields,\n  '$RefreshReg$',\n  'XMLHttpRequest',\n  'clearImmediate',\n  'clearInterval',\n  'clearTimeout',\n  'fetch',\n  'navigator',\n  'setImmediate',\n  'setInterval',\n  'setTimeout',\n]);\n\nconst isBrowserGlobal = (id: NodePath<Identifier>) => {\n  return forbiddenGlobals.has(id.node.name) && isGlobal(id);\n};\n\nconst isSSRCheckField = (id: NodePath<Identifier>) => {\n  return ssrCheckFields.has(id.node.name) && isGlobal(id);\n};\n\nconst getPropertyName = (path: NodePath): string | null => {\n  if (path.isIdentifier()) {\n    return path.node.name;\n  }\n\n  if (path.isStringLiteral()) {\n    return path.node.value;\n  }\n\n  return null;\n};\n\nexport const removeDangerousCode = (programPath: NodePath<Program>) => {\n  programPath.traverse(\n    {\n      // JSX can be replaced with a dummy value,\n      // but we have to do it after we processed template tags.\n      CallExpression: {\n        enter(p) {\n          if (isUnnecessaryReactCall(p)) {\n            JSXElementsRemover(p);\n          }\n        },\n      },\n      JSXElement: {\n        enter: JSXElementsRemover,\n      },\n      JSXFragment: {\n        enter: JSXElementsRemover,\n      },\n      MemberExpression(p, state) {\n        const obj = p.get('object');\n        const prop = p.get('property');\n        if (!obj.isIdentifier({ name: 'window' })) {\n          return;\n        }\n\n        const name = getPropertyName(prop);\n        if (!name) {\n          return;\n        }\n\n        state.windowScoped.add(name);\n        // eslint-disable-next-line no-param-reassign\n        state.globals = state.globals.filter((id) => {\n          if (id.node.name === name) {\n            removeWithRelated([id]);\n            return false;\n          }\n\n          return true;\n        });\n      },\n      MetaProperty(p) {\n        // Remove all references to `import.meta`\n        removeWithRelated([p]);\n      },\n      Identifier(p, state) {\n        if (p.find((parent) => parent.isTSTypeReference())) {\n          // don't mess with TS type references\n          return;\n        }\n        if (isBrowserGlobal(p)) {\n          if (\n            p.find(\n              (parentPath) =>\n                parentPath.isUnaryExpression({ operator: 'typeof' }) ||\n                parentPath.isTSTypeQuery()\n            )\n          ) {\n            // Ignore `typeof window` expressions\n            return;\n          }\n\n          if (p.parentPath.isClassProperty()) {\n            // ignore class property decls\n            return;\n          }\n          if (p.parentPath.isMemberExpression() && p.key === 'property') {\n            // ignore e.g this.fetch()\n            // window.fetch will be handled by the windowScoped block below\n            return;\n          }\n\n          removeWithRelated([p]);\n\n          return;\n        }\n\n        if (state.windowScoped.has(p.node.name)) {\n          removeWithRelated([p]);\n        } else if (isGlobal(p)) {\n          state.globals.push(p);\n        }\n      },\n\n      // Since we can use happy-dom, typical SSR checks may not work as expected.\n      // We need to detect them and replace with an \"undefined\" literal.\n      UnaryExpression(p) {\n        if (p.node.operator !== 'typeof') {\n          return;\n        }\n        const arg = p.get('argument');\n        if (!arg.isIdentifier() || !isSSRCheckField(arg)) {\n          return;\n        }\n\n        applyAction([\n          'replace',\n          p,\n          { type: 'StringLiteral', value: 'undefined' },\n        ]);\n      },\n    },\n    {\n      globals: [] as NodePath<Identifier>[],\n      windowScoped: new Set<string>(),\n    }\n  );\n};\n"],"mappings":"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","ignoreList":[]}