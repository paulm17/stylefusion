{"version":3,"file":"transform.js","names":["_buildOptions","require","_TransformMetadata","_getPluginKey","EMPTY_FILE","hasKeyInList","plugin","list","pluginKey","getPluginKey","some","i","includes","runPreevalStage","babel","evalConfig","pluginOptions","code","originalAst","eventEmitter","_evalConfig$plugins$f","_evalConfig$plugins","_evalConfig$plugins2","_result$ast","preShakePlugins","plugins","filter","highPriorityPlugins","resolve","transformConfig","buildOptions","envName","result","transformFromAstSync","ast","program","Error","prepareCode","services","item","log","only","loadedAndParsed","evaluator","_loadedAndParsed$code","options","preevalStageResult","perf","transformMetadata","getTransformMetadata","metadata","length","name","extend","evaluatorConfig","onlyExports","features","transformedCode","imports","exports","internalTransform","prepareFn","entrypoint","_loadedAndParsed$code2","preparedCode","_loadedAndParsed$code3","size","resolvedImports","getNext","resolved","transform","call"],"sources":["../../../src/transform/generators/transform.ts"],"sourcesContent":["import type {\n  BabelFileResult,\n  PluginItem,\n  TransformOptions,\n} from '@babel/core';\nimport type { File } from '@babel/types';\n\nimport type { EvaluatorConfig, StrictOptions } from '@wyw-in-js/shared';\n\nimport type { Core } from '../../babel';\nimport { buildOptions } from '../../options/buildOptions';\nimport type { EventEmitter } from '../../utils/EventEmitter';\nimport type { WYWTransformMetadata } from '../../utils/TransformMetadata';\nimport { getTransformMetadata } from '../../utils/TransformMetadata';\nimport { getPluginKey } from '../../utils/getPluginKey';\nimport type { Entrypoint } from '../Entrypoint';\nimport type {\n  ITransformAction,\n  Services,\n  SyncScenarioForAction,\n} from '../types';\n\nconst EMPTY_FILE = '=== empty file ===';\n\nconst hasKeyInList = (plugin: PluginItem, list: string[]): boolean => {\n  const pluginKey = getPluginKey(plugin);\n  return pluginKey ? list.some((i) => pluginKey.includes(i)) : false;\n};\n\nfunction runPreevalStage(\n  babel: Core,\n  evalConfig: TransformOptions,\n  pluginOptions: StrictOptions,\n  code: string,\n  originalAst: File,\n  eventEmitter: EventEmitter\n): BabelFileResult {\n  const preShakePlugins =\n    evalConfig.plugins?.filter((i) =>\n      hasKeyInList(i, pluginOptions.highPriorityPlugins)\n    ) ?? [];\n\n  const plugins = [\n    ...preShakePlugins,\n    [\n      require.resolve('../../plugins/preeval'),\n      { ...pluginOptions, eventEmitter },\n    ],\n    [require.resolve('../../plugins/dynamic-import')],\n    ...(evalConfig.plugins ?? []).filter(\n      (i) => !hasKeyInList(i, pluginOptions.highPriorityPlugins)\n    ),\n  ];\n\n  const transformConfig = buildOptions({\n    ...evalConfig,\n    envName: 'wyw-in-js',\n    plugins,\n  });\n\n  const result = babel.transformFromAstSync(originalAst, code, transformConfig);\n\n  if (!result || !result.ast?.program) {\n    throw new Error('Babel transform failed');\n  }\n\n  return result;\n}\n\ntype PrepareCodeFn = (\n  services: Services,\n  item: Entrypoint,\n  originalAst: File\n) => [\n  code: string,\n  imports: Map<string, string[]> | null,\n  metadata: WYWTransformMetadata | null,\n];\n\nexport const prepareCode = (\n  services: Services,\n  item: Entrypoint,\n  originalAst: File\n): ReturnType<PrepareCodeFn> => {\n  const { log, only, loadedAndParsed } = item;\n  if (loadedAndParsed.evaluator === 'ignored') {\n    log('is ignored');\n    return [loadedAndParsed.code ?? '', null, null];\n  }\n\n  const { code, evalConfig, evaluator } = loadedAndParsed;\n  const { options, babel, eventEmitter } = services;\n  const { pluginOptions } = options;\n\n  const preevalStageResult = eventEmitter.perf('transform:preeval', () =>\n    runPreevalStage(\n      babel,\n      evalConfig,\n      pluginOptions,\n      code,\n      originalAst,\n      eventEmitter\n    )\n  );\n\n  const transformMetadata = getTransformMetadata(preevalStageResult.metadata);\n\n  if (only.length === 1 && only[0] === '__wywPreval' && !transformMetadata) {\n    log('[evaluator:end] no metadata');\n    return [preevalStageResult.code!, null, null];\n  }\n\n  log('[preeval] metadata %O', transformMetadata);\n  log('[evaluator:start] using %s', evaluator.name);\n  log.extend('source')('%s', preevalStageResult.code!);\n\n  const evaluatorConfig: EvaluatorConfig = {\n    onlyExports: only,\n    highPriorityPlugins: pluginOptions.highPriorityPlugins,\n    features: pluginOptions.features,\n  };\n\n  const [, transformedCode, imports] = eventEmitter.perf(\n    'transform:evaluator',\n    () =>\n      evaluator(\n        evalConfig,\n        preevalStageResult.ast!,\n        preevalStageResult.code!,\n        evaluatorConfig,\n        babel\n      )\n  );\n\n  log('[evaluator:end]');\n\n  return [transformedCode, imports, transformMetadata ?? null];\n};\n\nexport function* internalTransform(\n  this: ITransformAction,\n  prepareFn: PrepareCodeFn\n): SyncScenarioForAction<ITransformAction> {\n  const { only, loadedAndParsed, log } = this.entrypoint;\n  if (loadedAndParsed.evaluator === 'ignored') {\n    log('is ignored');\n    return {\n      code: loadedAndParsed.code ?? '',\n      metadata: null,\n    };\n  }\n\n  log('>> (%o)', only);\n\n  const [preparedCode, imports, metadata] = prepareFn(\n    this.services,\n    this.entrypoint,\n    loadedAndParsed.ast\n  );\n\n  if (loadedAndParsed.code === preparedCode) {\n    log('<< (%o)\\n === no changes ===', only);\n  } else {\n    log('<< (%o)', only);\n    log.extend('source')('%s', preparedCode || EMPTY_FILE);\n  }\n\n  if (preparedCode === '') {\n    log('is skipped');\n    return {\n      code: loadedAndParsed.code ?? '',\n      metadata: null,\n    };\n  }\n\n  if (imports !== null && imports.size > 0) {\n    const resolvedImports = yield* this.getNext(\n      'resolveImports',\n      this.entrypoint,\n      {\n        imports,\n      }\n    );\n\n    if (resolvedImports.length !== 0) {\n      yield [\n        'processImports',\n        this.entrypoint,\n        {\n          resolved: resolvedImports,\n        },\n      ];\n    }\n  }\n\n  return {\n    code: preparedCode,\n    metadata,\n  };\n}\n\n/**\n * Prepares the code for evaluation. This includes removing dead and potentially unsafe code.\n * Emits resolveImports and processImports events.\n */\nexport function transform(this: ITransformAction) {\n  return internalTransform.call(this, prepareCode);\n}\n"],"mappings":"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","ignoreList":[]}