{"version":3,"file":"workflow.js","names":["_AbortError","require","workflow","_entrypoint$loadedAnd2","_collectStageResult$c","console","log","cache","options","services","entrypoint","ignored","_entrypoint$loadedAnd","code","loadedAndParsed","sourceMap","inputSourceMap","getNext","undefined","assertNotSuperseded","e","isAborted","supersededWith","originalCode","hasWywMetadata","generation","delete","name","evalStageResult","valueCache","dependencies","collectStageResult","metadata","map","extractStageResult","processors","replacements"],"sources":["../../../src/transform/generators/workflow.ts"],"sourcesContent":["import { isAborted } from '../actions/AbortError';\nimport type { IWorkflowAction, SyncScenarioForAction } from '../types';\n\n/**\n * The entry point for file processing. Sequentially calls `processEntrypoint`,\n * `evalFile`, `collect`, and `extract`. Returns the result of transforming\n * the source code as well as all artifacts obtained from code execution.\n */\nexport function* workflow(\n  this: IWorkflowAction\n): SyncScenarioForAction<IWorkflowAction> {\n  console.log(\"transform - workflow\");\n  const { cache, options } = this.services;\n  const { entrypoint } = this;\n\n  if (entrypoint.ignored) {\n    return {\n      code: entrypoint.loadedAndParsed.code ?? '',\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  try {\n    yield* this.getNext('processEntrypoint', entrypoint, undefined, null);\n    entrypoint.assertNotSuperseded();\n  } catch (e) {\n    if (isAborted(e) && entrypoint.supersededWith) {\n      entrypoint.log('workflow aborted, schedule the next attempt');\n      return yield* this.getNext(\n        'workflow',\n        entrypoint.supersededWith,\n        undefined,\n        null\n      );\n    }\n\n    throw e;\n  }\n\n  const originalCode = entrypoint.loadedAndParsed.code ?? '';\n\n  // File is ignored or does not contain any tags. Return original code.\n  if (!entrypoint.hasWywMetadata()) {\n    if (entrypoint.generation === 1) {\n      // 1st generation here means that it's __wywPreval entrypoint\n      // without __wywPreval, so we don't need it cached\n      cache.delete('entrypoints', entrypoint.name);\n    }\n\n    return {\n      code: originalCode,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  // *** 2nd stage ***\n\n  const evalStageResult = yield* this.getNext(\n    'evalFile',\n    entrypoint,\n    undefined,\n    null\n  );\n\n  if (evalStageResult === null) {\n    return {\n      code: originalCode,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  const [valueCache, dependencies] = evalStageResult;\n\n  // *** 3rd stage ***\n\n  const collectStageResult = yield* this.getNext(\n    'collect',\n    entrypoint,\n    {\n      valueCache,\n    },\n    null\n  );\n\n  if (!collectStageResult.metadata) {\n    return {\n      code: collectStageResult.code!,\n      sourceMap: collectStageResult.map,\n    };\n  }\n\n  // *** 4th stage\n\n  const extractStageResult = yield* this.getNext(\n    'extract',\n    entrypoint,\n    {\n      processors: collectStageResult.metadata.processors,\n    },\n    null\n  );\n\n  return {\n    ...extractStageResult,\n    code: collectStageResult.code ?? '',\n    dependencies,\n    replacements: [\n      ...extractStageResult.replacements,\n      ...collectStageResult.metadata.replacements,\n    ],\n    sourceMap: collectStageResult.map,\n  };\n}\n"],"mappings":"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","ignoreList":[]}