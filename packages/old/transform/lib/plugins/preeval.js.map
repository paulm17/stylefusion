{"version":3,"file":"preeval.js","names":["_shared","require","_getTagProcessor","_EventEmitter","_addIdentifierToWywPreval","_getFileIdx","_removeDangerousCode","_traversalCache","preeval","babel","options","_options$eventEmitter","console","log","types","t","eventEmitter","EventEmitter","dummy","name","pre","file","filename","opts","logger","extend","getFileIdx","rootScope","scope","processors","perf","applyProcessors","path","processor","dependencies","forEach","dependency","ex","type","addIdentifierToWywPreval","doEvaltimeReplacement","push","isFeatureEnabled","features","removeDangerousCode","visitor","post","invalidateTraversalCache","length","metadata","wywInJS","replacements","rules","wywPreval","getData","wywExport","expressionStatement","assignmentExpression","memberExpression","identifier","objectExpression","pushContainer","_default","exports","default"],"sources":["../../src/plugins/preeval.ts"],"sourcesContent":["/**\n * This file is a babel preset used to transform files inside evaluators.\n * It works the same as main `babel/extract` preset, but do not evaluate lazy dependencies.\n */\nimport type { BabelFile, PluginObj } from '@babel/core';\n\nimport type { StrictOptions } from '@wyw-in-js/shared';\nimport { isFeatureEnabled, logger } from '@wyw-in-js/shared';\n\nimport { applyProcessors } from '../utils/getTagProcessor';\nimport type { Core } from '../babel';\nimport type { IPluginState } from '../types';\nimport { EventEmitter } from '../utils/EventEmitter';\nimport { addIdentifierToWywPreval } from '../utils/addIdentifierToWywPreval';\nimport { getFileIdx } from '../utils/getFileIdx';\nimport { removeDangerousCode } from '../utils/removeDangerousCode';\nimport { invalidateTraversalCache } from '../utils/traversalCache';\n\nexport type PreevalOptions = Pick<\n  StrictOptions,\n  'classNameSlug' | 'displayName' | 'evaluate' | 'features' | 'tagResolver'\n> & { eventEmitter?: EventEmitter };\n\nexport function preeval(\n  babel: Core,\n  options: PreevalOptions\n): PluginObj<IPluginState & { onFinish: () => void }> {\n  console.log(\"preeval - preeval\");\n  const { types: t } = babel;\n  const eventEmitter = options.eventEmitter ?? EventEmitter.dummy;\n  return {\n    name: '@wyw-in-js/transform/preeval',\n    pre(file: BabelFile) {\n      const filename = file.opts.filename!;\n      const log = logger.extend('preeval').extend(getFileIdx(filename));\n\n      log('start', 'Looking for template literalsâ€¦');\n\n      const rootScope = file.scope;\n      this.processors = [];\n\n      eventEmitter.perf('transform:preeval:processTemplate', () => {\n        applyProcessors(file.path, file.opts, options, (processor) => {\n          processor.dependencies.forEach((dependency) => {\n            if (dependency.ex.type === 'Identifier') {\n              addIdentifierToWywPreval(rootScope, dependency.ex.name);\n            }\n          });\n\n          processor.doEvaltimeReplacement();\n          this.processors.push(processor);\n        });\n      });\n\n      if (\n        isFeatureEnabled(options.features, 'dangerousCodeRemover', filename)\n      ) {\n        log('start', 'Strip all JSX and browser related stuff');\n        eventEmitter.perf('transform:preeval:removeDangerousCode', () =>\n          removeDangerousCode(file.path)\n        );\n      }\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      const log = logger\n        .extend('preeval')\n        .extend(getFileIdx(file.opts.filename!));\n\n      invalidateTraversalCache(file.path);\n\n      if (this.processors.length === 0) {\n        log('end', \"We didn't find any wyw-in-js template literals\");\n\n        // We didn't find any wyw-in-js template literals.\n        return;\n      }\n\n      this.file.metadata.wywInJS = {\n        processors: this.processors,\n        replacements: [],\n        rules: {},\n        dependencies: [],\n      };\n\n      const wywPreval = file.path.getData('__wywPreval');\n      if (!wywPreval) {\n        // Event if there is no dependencies, we still need to add __wywPreval\n        const wywExport = t.expressionStatement(\n          t.assignmentExpression(\n            '=',\n            t.memberExpression(\n              t.identifier('exports'),\n              t.identifier('__wywPreval')\n            ),\n            t.objectExpression([])\n          )\n        );\n\n        file.path.pushContainer('body', wywExport);\n      }\n\n      log('end', '__wywPreval has been added');\n    },\n  };\n}\n\nexport default preeval;\n"],"mappings":"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","ignoreList":[]}