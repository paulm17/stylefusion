{"version":3,"file":"shaker.js","names":["_shared","require","_collectExportsAndImports","_getFileIdx","_isRemoved","_scopeHelpers","_traversalCache","EXT_REGEX","ALLOWED_EXTENSIONS","shouldKeepSideEffect","importPath","ext","match","includes","getBindingForExport","exportPath","console","log","isIdentifier","scope","getBinding","node","name","variableDeclarator","findParent","p","isVariableDeclarator","id","get","isAssignmentExpression","left","isFunctionDeclaration","isClassDeclaration","undefined","withoutRemoved","items","filter","local","isRemoved","rearrangeExports","types","t","root","exportRefs","exports","rearranged","rootScope","forEach","refs","_constantViolations","length","declarator","uid","generateUid","declaration","unshiftContainer","variableDeclaration","identifier","registerDeclaration","constantViolations","ref","replaced","replaceWith","isBindingIdentifier","push","reference","registerConstantViolation","assigmentToExport","expressionStatement","assignmentExpression","memberExpression","body","lastViolation","pathInRoot","find","n","isDescendant","pushed","insertAfter","shakerPlugin","babel","keepSideEffects","ifUnknownExport","onlyExports","shakerLogger","logger","extend","pre","file","filename","opts","getFileIdx","join","onlyExportsSet","Set","collected","collectExportsAndImports","path","sideEffectImports","imports","sideEffectImport","Object","values","reexports","hasWywPreval","__wywPreval","hasDefault","default","has","delete","size","deadExports","keys","remove","importedAsSideEffect","isEsModule","add","aliveExports","importNames","map","imported","entries","exported","some","alive","exp","exportToPath","Map","set","notFoundExports","clear","isAllExportsFound","Error","forDeleting","i","source","deleted","dereferenced","changed","binding","action","findActionForNode","parent","outerReferences","referencePaths","isAncestor","dereference","applyAction","removeWithRelated","unreferenced","getAllBindings","referenced","visitor","post","processedImports","addImport","metadata","wywEvaluator","invalidateTraversalCache"],"sources":["../../src/plugins/shaker.ts"],"sourcesContent":["import type { BabelFile, PluginObj, NodePath } from '@babel/core';\nimport type { Binding } from '@babel/traverse';\nimport type {\n  Identifier,\n  MemberExpression,\n  Program,\n  VariableDeclarator,\n} from '@babel/types';\n\nimport { logger } from '@wyw-in-js/shared';\n\nimport type { Core } from '../babel';\nimport type { IMetadata } from '../utils/ShakerMetadata';\nimport type { Exports, IState } from '../utils/collectExportsAndImports';\nimport {\n  collectExportsAndImports,\n  sideEffectImport,\n} from '../utils/collectExportsAndImports';\nimport { getFileIdx } from '../utils/getFileIdx';\nimport { isRemoved } from '../utils/isRemoved';\nimport {\n  applyAction,\n  dereference,\n  findActionForNode,\n  reference,\n  removeWithRelated,\n} from '../utils/scopeHelpers';\nimport { invalidateTraversalCache } from '../utils/traversalCache';\n\nconst EXT_REGEX = /\\.[0-9a-z]+$/;\nconst ALLOWED_EXTENSIONS = ['.js', '.cjs', '.mjs'];\n\nfunction shouldKeepSideEffect(importPath: string) {\n  const [ext] = importPath.match(EXT_REGEX) || [''];\n\n  return ext === '' || ALLOWED_EXTENSIONS.includes(ext);\n}\n\nexport interface IShakerOptions {\n  ifUnknownExport?: 'error' | 'ignore' | 'reexport-all' | 'skip-shaking';\n  keepSideEffects?: boolean;\n  onlyExports: string[];\n}\n\ninterface NodeWithName {\n  name: string;\n}\n\nfunction getBindingForExport(exportPath: NodePath): Binding | undefined {\n  console.log(\"shaker - getBindingForExport\");\n  if (exportPath.isIdentifier()) {\n    return exportPath.scope.getBinding(exportPath.node.name);\n  }\n\n  const variableDeclarator = exportPath.findParent((p) =>\n    p.isVariableDeclarator()\n  ) as NodePath<VariableDeclarator> | undefined;\n  if (variableDeclarator) {\n    const id = variableDeclarator.get('id');\n    if (id.isIdentifier()) {\n      return variableDeclarator.scope.getBinding(id.node.name);\n    }\n  }\n\n  if (exportPath.isAssignmentExpression()) {\n    const left = exportPath.get('left');\n    if (left.isIdentifier()) {\n      return exportPath.scope.getBinding(left.node.name);\n    }\n  }\n\n  if (exportPath.isFunctionDeclaration() || exportPath.isClassDeclaration()) {\n    return exportPath.scope.getBinding(exportPath.node.id!.name);\n  }\n\n  return undefined;\n}\n\nconst withoutRemoved = <T extends { local: NodePath }>(items: T[]): T[] =>\n  items.filter(({ local }) => !isRemoved(local));\n\nfunction rearrangeExports(\n  { types: t }: Core,\n  root: NodePath<Program>,\n  exportRefs: Map<string, NodePath<MemberExpression>[]>,\n  exports: Exports\n): Exports {\n  console.log(\"shaker - rearrangeExports\");\n  const rearranged = {\n    ...exports,\n  };\n\n  const rootScope = root.scope;\n  exportRefs.forEach((refs, name) => {\n    if (refs.length <= 1) {\n      if (refs.length === 1) {\n        // Maybe exports is assigned to another variable?\n        const declarator = refs[0].findParent((p) =>\n          p.isVariableDeclarator()\n        ) as NodePath<VariableDeclarator> | undefined;\n\n        if (!declarator) {\n          return;\n        }\n      } else {\n        return;\n      }\n    }\n\n    const uid = rootScope.generateUid(name);\n    // Define variable in the beginning\n    const [declaration] = root.unshiftContainer('body', [\n      t.variableDeclaration('var', [t.variableDeclarator(t.identifier(uid))]),\n    ]);\n\n    rootScope.registerDeclaration(declaration);\n\n    const constantViolations: NodePath<Identifier>[] = [];\n    // Replace every reference with defined variable\n    refs.forEach((ref) => {\n      const [replaced] = ref.replaceWith(t.identifier(uid));\n      if (replaced.isBindingIdentifier()) {\n        constantViolations.push(replaced);\n      } else {\n        reference(replaced);\n      }\n    });\n\n    constantViolations.forEach((id) => {\n      rootScope.registerConstantViolation(id);\n    });\n\n    const assigmentToExport = t.expressionStatement(\n      t.assignmentExpression(\n        '=',\n        t.memberExpression(t.identifier('exports'), t.identifier(name)),\n        t.identifier(uid)\n      )\n    );\n\n    // export.foo = _foo will be inserted either after the last _foo assigment or in the end of the file\n    const body = root.get('body');\n    const lastViolation =\n      constantViolations[constantViolations.length - 1] ??\n      body[body.length - 1];\n    const pathInRoot = root\n      .get('body')\n      .find((n) => lastViolation.isDescendant(n))!;\n\n    const [pushed] = pathInRoot.insertAfter(assigmentToExport);\n\n    const local = pushed.get('expression.right') as NodePath<Identifier>;\n    reference(local);\n\n    rearranged[name] = local;\n  });\n\n  return rearranged;\n}\n\nexport default function shakerPlugin(\n  babel: Core,\n  {\n    keepSideEffects = false,\n    ifUnknownExport = 'skip-shaking',\n    onlyExports,\n  }: IShakerOptions\n): PluginObj<IState & { filename: string }> {\n  console.log(\"shaker - shakerPlugin\");\n  const shakerLogger = logger.extend('shaker');\n\n  return {\n    name: '@wyw-in-js/transform/shaker',\n    pre(file: BabelFile) {\n      this.filename = file.opts.filename!;\n      const log = shakerLogger.extend(getFileIdx(this.filename));\n\n      log('start', `${this.filename}, onlyExports: ${onlyExports.join(',')}`);\n      const onlyExportsSet = new Set(onlyExports);\n\n      const collected = collectExportsAndImports(file.path);\n      const sideEffectImports = collected.imports.filter(sideEffectImport);\n      log(\n        'import-and-exports',\n        [\n          `imports: ${collected.imports.length} (side-effects: ${sideEffectImports.length})`,\n          `exports: ${Object.values(collected.exports).length}`,\n          `reexports: ${collected.reexports.length}`,\n        ].join(', ')\n      );\n\n      // We cannot just throw out exports if they are referred in the code\n      // Let's dome some replacements\n      const exports = rearrangeExports(\n        babel,\n        file.path,\n        collected.exportRefs,\n        collected.exports\n      );\n\n      Object.values(exports).forEach((local) => {\n        if (local.isAssignmentExpression()) {\n          const left = local.get('left');\n          if (left.isIdentifier()) {\n            // For some reason babel does not mark id in AssignmentExpression as a reference\n            // So we need to do it manually\n            reference(left, left, true);\n          }\n        }\n      });\n\n      const hasWywPreval = exports.__wywPreval !== undefined;\n      const hasDefault = exports.default !== undefined;\n\n      // If __wywPreval is not exported, we can remove it from onlyExports\n      if (onlyExportsSet.has('__wywPreval') && !hasWywPreval) {\n        onlyExportsSet.delete('__wywPreval');\n      }\n\n      if (onlyExportsSet.size === 0) {\n        // Fast-lane: if there are no exports to keep, we can just shake out the whole file\n        this.imports = [];\n        this.exports = {};\n        this.reexports = [];\n        this.deadExports = Object.keys(exports);\n\n        file.path.get('body').forEach((p) => {\n          p.remove();\n        });\n\n        return;\n      }\n\n      const importedAsSideEffect = onlyExportsSet.has('side-effect');\n      onlyExportsSet.delete('side-effect');\n\n      // Hackaround for packages which include a 'default' export without specifying __esModule; such packages cannot be\n      // shaken as they will break interopRequireDefault babel helper\n      // See example in shaker-plugin.test.ts\n      // Real-world example was found in preact/compat npm package\n      if (\n        onlyExportsSet.has('default') &&\n        hasDefault &&\n        !collected.isEsModule\n      ) {\n        this.imports = collected.imports;\n        this.exports = exports;\n        this.reexports = collected.reexports;\n        this.deadExports = [];\n        return;\n      }\n\n      if (!onlyExportsSet.has('*')) {\n        // __esModule should be kept alive\n        onlyExportsSet.add('__esModule');\n\n        const aliveExports = new Set<NodePath>();\n        const importNames = collected.imports.map(({ imported }) => imported);\n\n        Object.entries(exports).forEach(([exported, local]) => {\n          if (onlyExportsSet.has(exported)) {\n            aliveExports.add(local);\n          } else if (\n            importNames.includes((local.node as NodeWithName).name || '')\n          ) {\n            aliveExports.add(local);\n          } else if ([...aliveExports].some((alive) => alive === local)) {\n            // It's possible to export multiple values from a single variable initializer, e.g\n            // export const { foo, bar } = baz();\n            // We need to treat all of them as used if any of them are used, since otherwise\n            // we'll attempt to delete the baz() call\n            aliveExports.add(local);\n          }\n        });\n\n        collected.reexports.forEach((exp) => {\n          if (onlyExportsSet.has(exp.exported)) {\n            aliveExports.add(exp.local);\n          }\n        });\n\n        const exportToPath = new Map<string, NodePath>();\n        Object.entries(exports).forEach(([exported, local]) => {\n          exportToPath.set(exported, local);\n        });\n\n        collected.reexports.forEach((exp) => {\n          exportToPath.set(exp.exported, exp.local);\n        });\n\n        const notFoundExports = [...onlyExportsSet].filter(\n          (exp) =>\n            exp !== '__esModule' && !aliveExports.has(exportToPath.get(exp)!)\n        );\n        exportToPath.clear();\n\n        const isAllExportsFound = notFoundExports.length === 0;\n        if (!isAllExportsFound && ifUnknownExport !== 'ignore') {\n          if (ifUnknownExport === 'error') {\n            throw new Error(\n              `Unknown export(s) requested: ${onlyExports.join(',')}`\n            );\n          }\n\n          if (ifUnknownExport === 'reexport-all') {\n            // If there are unknown exports, we have keep alive all re-exports.\n            if (exports['*'] !== undefined) {\n              aliveExports.add(exports['*']);\n            }\n\n            collected.reexports.forEach((exp) => {\n              if (exp.exported === '*') {\n                aliveExports.add(exp.local);\n              }\n            });\n          }\n\n          if (ifUnknownExport === 'skip-shaking') {\n            this.imports = collected.imports;\n            this.exports = exports;\n            this.reexports = collected.reexports;\n            this.deadExports = [];\n\n            return;\n          }\n        }\n\n        const forDeleting = [\n          ...Object.values(exports),\n          ...collected.reexports.map((i) => i.local),\n        ].filter((exp) => !aliveExports.has(exp));\n\n        if (!keepSideEffects && !importedAsSideEffect) {\n          // Remove all imports that don't import something explicitly and should not be kept\n          sideEffectImports.forEach((i) => {\n            if (!shouldKeepSideEffect(i.source)) {\n              forDeleting.push(i.local);\n            }\n          });\n        }\n\n        const deleted = new Set<NodePath>();\n\n        let dereferenced: NodePath<Identifier>[] = [];\n        let changed = true;\n        while (changed && deleted.size < forDeleting.length) {\n          changed = false;\n          // eslint-disable-next-line no-restricted-syntax\n          for (const path of forDeleting) {\n            if (deleted.has(path)) {\n              // eslint-disable-next-line no-continue\n              continue;\n            }\n\n            const binding = getBindingForExport(path);\n            const action = findActionForNode(path);\n            const parent = action?.[1];\n            const outerReferences = (binding?.referencePaths || []).filter(\n              (ref) => ref !== parent && !parent?.isAncestor(ref)\n            );\n            if (outerReferences.length > 0 && path.isIdentifier()) {\n              // Temporary deref it in order to simplify further checks.\n              dereference(path);\n              dereferenced.push(path);\n            }\n\n            if (\n              !deleted.has(path) &&\n              (!binding || outerReferences.length === 0)\n            ) {\n              if (action) {\n                applyAction(action);\n              } else {\n                removeWithRelated([path]);\n              }\n\n              deleted.add(path);\n              changed = true;\n            }\n          }\n\n          dereferenced.forEach((path) => {\n            // If path is still alive, we need to reference it back\n            if (!isRemoved(path)) {\n              reference(path);\n            }\n          });\n\n          dereferenced = [];\n\n          // Find and mark for deleting all unreferenced variables\n          const unreferenced = Object.values(\n            file.scope.getAllBindings()\n          ).filter((i) => !i.referenced);\n\n          for (const binding of unreferenced) {\n            if (\n              binding.path.isVariableDeclarator() &&\n              !forDeleting.includes(binding.path.get('id'))\n            ) {\n              forDeleting.push(...binding.constantViolations);\n              forDeleting.push(binding.path.get('id'));\n              changed = true;\n            }\n          }\n        }\n      }\n\n      this.imports = withoutRemoved(collected.imports);\n      this.exports = {};\n      this.deadExports = [];\n\n      Object.entries(exports).forEach(([exported, local]) => {\n        if (isRemoved(local)) {\n          this.deadExports.push(exported);\n        } else {\n          this.exports[exported] = local;\n        }\n      });\n\n      this.reexports = withoutRemoved(collected.reexports);\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      const log = shakerLogger.extend(getFileIdx(file.opts.filename!));\n\n      const processedImports = new Set<string>();\n      const imports = new Map<string, string[]>();\n      const addImport = ({\n        imported,\n        source,\n      }: {\n        imported: string;\n        source: string;\n      }) => {\n        if (processedImports.has(`${source}:${imported}`)) {\n          return;\n        }\n\n        if (!imports.has(source)) {\n          imports.set(source, []);\n        }\n\n        if (imported) {\n          imports.get(source)!.push(imported);\n        }\n\n        processedImports.add(`${source}:${imported}`);\n      };\n\n      this.imports.forEach(addImport);\n      this.reexports.forEach(addImport);\n\n      log('end', `remaining imports: %O`, imports);\n\n      // eslint-disable-next-line no-param-reassign\n      (file.metadata as IMetadata).wywEvaluator = {\n        imports,\n      };\n\n      invalidateTraversalCache(file.path);\n    },\n  };\n}\n"],"mappings":"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","ignoreList":[]}