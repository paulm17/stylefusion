{"version":3,"file":"babel-transform.js","names":["_shared","require","_loadWywOptions","_cache","_transform","_collector","babelTransform","babel","options","console","log","cache","TransformCacheCollection","debug","logger","extend","name","pre","file","_file$opts$root","_file$opts$inputSourc","collect","valueCache","data","loadedAndParsed","entrypoint","pluginOptions","services","evaluator","Error","collector","ast","code","opts","filename","loadWywOptions","transformSync","root","undefined","inputSourceMap","syncResolve","visitor","post"],"sources":["../../src/plugins/babel-transform.ts"],"sourcesContent":["import type { BabelFile, PluginObj } from '@babel/core';\n\nimport { logger, syncResolve } from '@wyw-in-js/shared';\n\nimport { loadWywOptions } from '../transform/helpers/loadWywOptions';\nimport type { Core } from '../babel';\nimport { TransformCacheCollection } from '../cache';\nimport { transformSync } from '../transform';\nimport type { ICollectAction, SyncScenarioForAction } from '../transform/types';\nimport type { IPluginState, PluginOptions } from '../types';\n\nimport { collector } from './collector';\n\nexport default function babelTransform(\n  babel: Core,\n  options: Partial<PluginOptions>\n): PluginObj<IPluginState> {\n  console.log(\"babel-transform - bableTransform\");\n  const cache = new TransformCacheCollection();\n  const debug = logger.extend('babel-transform');\n\n  return {\n    name: '@wyw-in-js/transform/babel-transform',\n    pre(file: BabelFile) {\n      // eslint-disable-next-line require-yield\n      function* collect(\n        this: ICollectAction\n      ): SyncScenarioForAction<ICollectAction> {\n        const { valueCache } = this.data;\n        const { loadedAndParsed } = this.entrypoint;\n        const { pluginOptions } = this.services.options;\n        if (loadedAndParsed.evaluator === 'ignored') {\n          throw new Error('entrypoint was ignored');\n        }\n\n        collector(file, pluginOptions, valueCache);\n\n        return {\n          ast: loadedAndParsed.ast,\n          code: loadedAndParsed.code,\n        };\n      }\n\n      debug('start %s', file.opts.filename);\n\n      const pluginOptions = loadWywOptions(options);\n\n      transformSync(\n        {\n          babel,\n          cache,\n          options: {\n            filename: file.opts.filename!,\n            root: file.opts.root ?? undefined,\n            inputSourceMap: file.opts.inputSourceMap ?? undefined,\n            pluginOptions,\n          },\n        },\n        file.code,\n        syncResolve,\n        {\n          collect,\n        }\n      );\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      debug('end %s', file.opts.filename);\n    },\n  };\n}\n"],"mappings":";;;;;;AAEA,IAAAA,OAAA,GAAAC,OAAA;AAEA,IAAAC,eAAA,GAAAD,OAAA;AAEA,IAAAE,MAAA,GAAAF,OAAA;AACA,IAAAG,UAAA,GAAAH,OAAA;AAIA,IAAAI,UAAA,GAAAJ,OAAA;AAEe,SAASK,cAAcA,CACpCC,KAAW,EACXC,OAA+B,EACN;EACzBC,OAAO,CAACC,GAAG,CAAC,kCAAkC,CAAC;EAC/C,MAAMC,KAAK,GAAG,IAAIC,+BAAwB,CAAC,CAAC;EAC5C,MAAMC,KAAK,GAAGC,cAAM,CAACC,MAAM,CAAC,iBAAiB,CAAC;EAE9C,OAAO;IACLC,IAAI,EAAE,sCAAsC;IAC5CC,GAAGA,CAACC,IAAe,EAAE;MAAA,IAAAC,eAAA,EAAAC,qBAAA;MACnB;MACA,UAAUC,OAAOA,CAAA,EAEwB;QACvC,MAAM;UAAEC;QAAW,CAAC,GAAG,IAAI,CAACC,IAAI;QAChC,MAAM;UAAEC;QAAgB,CAAC,GAAG,IAAI,CAACC,UAAU;QAC3C,MAAM;UAAEC;QAAc,CAAC,GAAG,IAAI,CAACC,QAAQ,CAACnB,OAAO;QAC/C,IAAIgB,eAAe,CAACI,SAAS,KAAK,SAAS,EAAE;UAC3C,MAAM,IAAIC,KAAK,CAAC,wBAAwB,CAAC;QAC3C;QAEA,IAAAC,oBAAS,EAACZ,IAAI,EAAEQ,aAAa,EAAEJ,UAAU,CAAC;QAE1C,OAAO;UACLS,GAAG,EAAEP,eAAe,CAACO,GAAG;UACxBC,IAAI,EAAER,eAAe,CAACQ;QACxB,CAAC;MACH;MAEAnB,KAAK,CAAC,UAAU,EAAEK,IAAI,CAACe,IAAI,CAACC,QAAQ,CAAC;MAErC,MAAMR,aAAa,GAAG,IAAAS,8BAAc,EAAC3B,OAAO,CAAC;MAE7C,IAAA4B,wBAAa,EACX;QACE7B,KAAK;QACLI,KAAK;QACLH,OAAO,EAAE;UACP0B,QAAQ,EAAEhB,IAAI,CAACe,IAAI,CAACC,QAAS;UAC7BG,IAAI,GAAAlB,eAAA,GAAED,IAAI,CAACe,IAAI,CAACI,IAAI,cAAAlB,eAAA,cAAAA,eAAA,GAAImB,SAAS;UACjCC,cAAc,GAAAnB,qBAAA,GAAEF,IAAI,CAACe,IAAI,CAACM,cAAc,cAAAnB,qBAAA,cAAAA,qBAAA,GAAIkB,SAAS;UACrDZ;QACF;MACF,CAAC,EACDR,IAAI,CAACc,IAAI,EACTQ,mBAAW,EACX;QACEnB;MACF,CACF,CAAC;IACH,CAAC;IACDoB,OAAO,EAAE,CAAC,CAAC;IACXC,IAAIA,CAACxB,IAAe,EAAE;MACpBL,KAAK,CAAC,QAAQ,EAAEK,IAAI,CAACe,IAAI,CAACC,QAAQ,CAAC;IACrC;EACF,CAAC;AACH","ignoreList":[]}