{"version":3,"file":"transform.js","names":["_shared","require","_loadWywOptions","_cache","_Entrypoint","_actionRunner","_generators","_resolveImports","_withDefaultServices","transformSync","partialServices","originalCode","syncResolve","customHandlers","console","log","options","pluginOptions","loadWywOptions","services","withDefaultServices","isFeatureEnabled","features","filename","cache","TransformCacheCollection","entrypoint","Entrypoint","createRoot","ignored","code","sourceMap","inputSourceMap","workflowAction","createAction","undefined","result","syncActionRunner","baseHandlers","resolveImports","syncResolveImports","call","name","err","error","transform","asyncResolve","asyncActionRunner","asyncResolveImports"],"sources":["../src/transform.ts"],"sourcesContent":["/**\n * This file exposes sync and async transform functions that:\n * - parse the passed code to AST\n * - builds a dependency graph for the file\n * - shakes each dependency and removes unused code\n * - runs generated code in a sandbox\n * - collects artifacts\n * - returns transformed code (without WYW template literals), generated CSS, source maps and babel metadata from transform step.\n */\n\nimport { isFeatureEnabled } from '@wyw-in-js/shared';\n\nimport type { PartialOptions } from './transform/helpers/loadWywOptions';\nimport { loadWywOptions } from './transform/helpers/loadWywOptions';\nimport { TransformCacheCollection } from './cache';\nimport { Entrypoint } from './transform/Entrypoint';\nimport {\n  asyncActionRunner,\n  syncActionRunner,\n} from './transform/actions/actionRunner';\nimport { baseHandlers } from './transform/generators';\nimport {\n  asyncResolveImports,\n  syncResolveImports,\n} from './transform/generators/resolveImports';\nimport { withDefaultServices } from './transform/helpers/withDefaultServices';\nimport type {\n  Handlers,\n  IResolveImportsAction,\n  Services,\n} from './transform/types';\nimport type { Result } from './types';\n\ntype PartialServices = Partial<Omit<Services, 'options'>> & {\n  options: Omit<Services['options'], 'pluginOptions'> & {\n    pluginOptions?: PartialOptions;\n  };\n};\n\ntype AllHandlers<TMode extends 'async' | 'sync'> = Handlers<TMode>;\n\nexport function transformSync(\n  partialServices: PartialServices,\n  originalCode: string,\n  syncResolve: (what: string, importer: string, stack: string[]) => string,\n  customHandlers: Partial<AllHandlers<'sync'>> = {}\n): Result {\n  console.log(\"transform - transformSync\");\n  const { options } = partialServices;\n  const pluginOptions = loadWywOptions(options.pluginOptions);\n  const services = withDefaultServices({\n    ...partialServices,\n    options: {\n      ...options,\n      pluginOptions,\n    },\n  });\n\n  if (\n    !isFeatureEnabled(pluginOptions.features, 'globalCache', options.filename)\n  ) {\n    // If global cache is disabled, we need to create a new cache for each file\n    services.cache = new TransformCacheCollection();\n  }\n\n  const entrypoint = Entrypoint.createRoot(\n    services,\n    options.filename,\n    ['__wywPreval'],\n    originalCode\n  );\n\n  if (entrypoint.ignored) {\n    return {\n      code: originalCode,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  const workflowAction = entrypoint.createAction('workflow', undefined);\n\n  try {\n    const result = syncActionRunner(workflowAction, {\n      ...baseHandlers,\n      ...customHandlers,\n      resolveImports() {\n        return syncResolveImports.call(this, syncResolve);\n      },\n    });\n\n    entrypoint.log('%s is ready', entrypoint.name);\n\n    return result;\n  } catch (err) {\n    entrypoint.log('Unhandled error %O', err);\n\n    if (\n      isFeatureEnabled(pluginOptions.features, 'softErrors', options.filename)\n    ) {\n      // eslint-disable-next-line no-console\n      console.error(`Error during transform of ${entrypoint.name}:`, err);\n\n      return {\n        code: originalCode,\n        sourceMap: options.inputSourceMap,\n      };\n    }\n\n    throw err;\n  }\n}\n\nexport async function transform(\n  partialServices: PartialServices,\n  originalCode: string,\n  asyncResolve: (\n    what: string,\n    importer: string,\n    stack: string[]\n  ) => Promise<string | null>,\n  customHandlers: Partial<AllHandlers<'sync'>> = {}\n): Promise<Result> {\n  console.log(\"transform - transform\");\n  const { options } = partialServices;\n  const pluginOptions = loadWywOptions(options.pluginOptions);\n  const services = withDefaultServices({\n    ...partialServices,\n    options: {\n      ...options,\n      pluginOptions,\n    },\n  });\n\n  if (\n    !isFeatureEnabled(pluginOptions.features, 'globalCache', options.filename)\n  ) {\n    // If global cache is disabled, we need to create a new cache for each file\n    services.cache = new TransformCacheCollection();\n  }\n\n  /*\n   * This method can be run simultaneously for multiple files.\n   * A shared cache is accessible for all runs, but each run has its own queue\n   * to maintain the correct processing order. The cache stores the outcome\n   * of tree-shaking, and if the result is already stored in the cache\n   * but the \"only\" option has changed, the file will be re-processed using\n   * the combined \"only\" option.\n   */\n  const entrypoint = Entrypoint.createRoot(\n    services,\n    options.filename,\n    ['__wywPreval'],\n    originalCode\n  );\n\n  if (entrypoint.ignored) {\n    return {\n      code: originalCode,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  const workflowAction = entrypoint.createAction('workflow', undefined);\n\n  try {\n    const result = await asyncActionRunner(workflowAction, {\n      ...baseHandlers,\n      ...customHandlers,\n      resolveImports(this: IResolveImportsAction) {\n        return asyncResolveImports.call(this, asyncResolve);\n      },\n    });\n\n    console.log(`${entrypoint.name} is ready`);\n    // console.log(\"result\", result);\n\n    entrypoint.log('%s is ready', entrypoint.name);\n\n    return result;\n  } catch (err) {\n    entrypoint.log('Unhandled error %O', err);\n\n    if (\n      isFeatureEnabled(pluginOptions.features, 'softErrors', options.filename)\n    ) {\n      // eslint-disable-next-line no-console\n      console.error(`Error during transform of ${entrypoint.name}:`, err);\n\n      return {\n        code: originalCode,\n        sourceMap: options.inputSourceMap,\n      };\n    }\n\n    throw err;\n  }\n}\n"],"mappings":"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","ignoreList":[]}